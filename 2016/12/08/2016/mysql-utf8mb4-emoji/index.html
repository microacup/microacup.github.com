<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="theme-color" content="#202020"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="keywords" content="MySQL,编码,emoji,"><meta name="description" content="MySQL修改字符集编码为utf8mb4支持emoji存储"><link rel="icon" type="image/x-icon" href="/logo.png"><title>MySQL修改字符集编码为utf8mb4支持emoji存储 [ 大新闻 ]</title><link rel="stylesheet" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" href="/css/microb.css"></head><body><nav class="home-menu pure-menu pure-menu-horizontal pure-menu-fixed"><ul class="pure-menu-list float-r clearfix"><li class="pure-menu-item toc-menu"><a id="menu-main-post" class="pure-menu-link" href="javascript:;"><img class="menu-icon" src="/logo.png" alt="MENU"></a></li></ul><a class="pure-menu-heading" href="/"><h1 class="title">大新闻</h1></a></nav><div class="container" id="content-outer"><div class="inner" id="content-inner"><article class="post" id="post"><header class="post-header text-center"><h1 class="title">MySQL修改字符集编码为utf8mb4支持emoji存储</h1><time class="time" datetime="2016-12-08T01:50:59.000Z">2016-12-08</time><hr></header><div class="post-content"><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><ul><li>MySQL 5.5.3+</li><li>JDBC驱动5.1.14+</li></ul><h2 id="关于utf8mb4编码"><a href="#关于utf8mb4编码" class="headerlink" title="关于utf8mb4编码"></a>关于utf8mb4编码</h2><p>MySQL在5.5.3之后增加了这个utf8mb4的编码，mb4就是most bytes 4的意思，专门用来兼容四字节的unicode。好在utf8mb4是utf8的超集，除了将编码改为utf8bp4外不需要做其他转换。</p><p>三个字节的 UTF-8 最大能编码的 Unicode 字符是 0xffff，也就是 Unicode 中的基本多文种平面（BMP）。也就是说，任何不在基本多文本平面的 Unicode字符，都无法使用 Mysql 的 utf8 字符集存储。包括 <a href="http://my.oschina.net/wingyiu/blog/153357" target="_blank" rel="external">Emoji 表情</a>（Emoji 是一种特殊的 Unicode 编码，常见于 ios 和 android 手机上），和很多不常用的汉字，以及任何新增的 Unicode 字符等等。</p><p>由于utf8 编码最大字符长度为 3 字节，如果遇到 4 字节的宽字符就会插入异常了:</p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">Caused by: java.sql.SQLException: Incorrect string value: &apos;\xF0\x9F\x98\x97\xF0\x9F...&apos; for column &apos;CONTENT&apos; at row 1</div></pre></td></tr></table></figure><p>对应的解决方案就是修改字符编码为utf8mb4.</p><hr><p>划重点</p><hr><h3 id="修改数据库表结构-必须"><a href="#修改数据库表结构-必须" class="headerlink" title="修改数据库表结构(必须)"></a>修改数据库表结构(必须)</h3><figure class="highlight sql"><table><tr><td class="code"><pre><div class="line"><span class="comment">--修改数据库字符集</span></div><div class="line"><span class="keyword">ALTER</span> <span class="keyword">DATABASE</span> <span class="keyword">test</span> <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> = utf8mb4;</div><div class="line"><span class="comment">--修改表字符集</span></div><div class="line"><span class="keyword">alter</span> <span class="keyword">table</span> <span class="keyword">test</span> <span class="keyword">convert</span> <span class="keyword">to</span> <span class="built_in">character</span> <span class="keyword">set</span> utf8mb4;</div><div class="line"><span class="comment">--修改字符字符集</span></div><div class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="string">`test`</span> <span class="keyword">CHANGE</span> <span class="keyword">COLUMN</span> <span class="string">`name`</span> <span class="string">`name`</span> <span class="built_in">varchar</span>(<span class="number">12</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8mb4;</div></pre></td></tr></table></figure><h3 id="修改Mysql配置文件my-ini（必须）"><a href="#修改Mysql配置文件my-ini（必须）" class="headerlink" title="修改Mysql配置文件my.ini（必须）"></a>修改Mysql配置文件my.ini（必须）</h3><p>根据版本不同，可能并非所有配置项都存在，只需要修改存在的即可。修改后重启MySQL</p><figure class="highlight ini"><table><tr><td class="code"><pre><div class="line"><span class="section">[client]</span></div><div class="line"><span class="attr">default-character-set</span> = utf8mb4</div><div class="line"><span class="section">[mysqld]</span></div><div class="line"><span class="attr">character-set-server</span>=utf8mb4</div><div class="line"><span class="attr">collation-server</span>=utf8mb4_unicode_ci</div><div class="line"><span class="section">[mysql]</span></div><div class="line"><span class="attr">default-character-set</span> = utf8mb4</div></pre></td></tr></table></figure><p>如果你使用的是java语言，需要将jdbc驱动包升级到 mysql-connector-java-5.1.14.jar。</p><hr><p>全剧终。</p><hr><h2 id="番外篇"><a href="#番外篇" class="headerlink" title="番外篇"></a>番外篇</h2><h3 id="关于异常Specified-key-was-too-long"><a href="#关于异常Specified-key-was-too-long" class="headerlink" title="关于异常Specified key was too long"></a>关于异常Specified key was too long</h3><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">alter table m_reply convert to character set utf8mb4	Error Code: 1071. Specified key was too long; max key length is 767 bytes</div></pre></td></tr></table></figure><p>在修改表字符集时，可能会遇到上面的异常，解决方式就是，把长度大于768/4=192的索引改小。</p><p>报错原因在于：MySQL Innodb 的索引长度限制为 767 字节，UTF8mb4 字符集是 4 个字节，<br><strong>767 字节 / 4 字节每字符 = 191 字符（即默认的索引最大长度）</strong><br>因此在 varchar(255) 类型字段上，创建索引会失败，提示最大索引长度为767字节。具体请google。</p><p>PS：在5.7版本未出现上述问题。</p><h3 id="utf8mb4-unicode-ci-还是-utf8mb4-general-ci"><a href="#utf8mb4-unicode-ci-还是-utf8mb4-general-ci" class="headerlink" title="utf8mb4_unicode_ci 还是 utf8mb4_general_ci"></a>utf8mb4_unicode_ci 还是 utf8mb4_general_ci</h3><p>在性能方面考虑，utf8mb4_unicode_ci 。具体请google。</p><h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><ul><li><a href="https://my.oschina.net/leejun2005/blog/343353" target="_blank" rel="external">关于 MySQL UTF8 编码下生僻字符插入失败/假死问题的分析</a></li><li><a href="https://my.oschina.net/leejun2005/blog/232732#OSC_h3_4" target="_blank" rel="external">谈谈字符集与字符编码</a></li><li><a href="https://ruby-china.org/topics/24693" target="_blank" rel="external">阿里云 Rails 项目调整 RDS MySQL 编码为 utf8mb4 的详细步骤</a></li></ul></div><div class="post-tags"><ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MySQL/">MySQL</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/emoji/">emoji</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/编码/">编码</a></li></ul></div></article><div class="post-nav"><div class="post-nav-item post-nav-next"><a href="/2016/12/06/2016/OAuth2 Server实现/" rel="next" title="基于oltu的oauth2 server"><span>〈 </span>基于oltu的oauth2 server</a></div><div class="post-nav-item post-nav-prev"><a href="/2016/12/14/2016/vue-element/" rel="prev" title="vue-element入坑体验">vue-element入坑体验 <span>〉</span></a></div></div><div id="toc" class="toc-article"><strong class="toc-title">目录</strong><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#环境"><span class="toc-text">环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#关于utf8mb4编码"><span class="toc-text">关于utf8mb4编码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#修改数据库表结构-必须"><span class="toc-text">修改数据库表结构(必须)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#修改Mysql配置文件my-ini（必须）"><span class="toc-text">修改Mysql配置文件my.ini（必须）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#番外篇"><span class="toc-text">番外篇</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#关于异常Specified-key-was-too-long"><span class="toc-text">关于异常Specified key was too long</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#utf8mb4-unicode-ci-还是-utf8mb4-general-ci"><span class="toc-text">utf8mb4_unicode_ci 还是 utf8mb4_general_ci</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#参考链接"><span class="toc-text">参考链接</span></a></li></ol></li></ol></div></div></div><footer class="footer text-center"><div id="bottom-inner"><a href="" target="_blank" class="footer-link">Hexo</a> <a href="" target="_blank" class="footer-link">Theme microb</a></div></footer><script>var titleTime,originTitle=document.title;document.addEventListener("visibilitychange",function(){document.hidden?(document.title="[闷声发大财中...] "+originTitle,clearTimeout(titleTime)):(document.title="[+1s] "+originTitle,titleTime=setTimeout(function(){document.title=originTitle},2e3))})</script><script>!function(n,e){!function(){var n=e.getElementById("menu-main-post");if(n){var t=e.getElementById("toc");t?n.onclick=function(){t&&("block"==t.style.display?t.style.display="none":t.style.display="block")}:n.style.display="none"}}()}(window,document)</script><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?b6d76ecb62c0651d8e5b7f7085f443f1";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script>!function(e,a,t,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=a.createElement(t),s=a.getElementsByTagName(t)[0],o.async=1,o.src="//www.google-analytics.com/analytics.js",s.parentNode.insertBefore(o,s)}(window,document,"script",0,"ga"),ga("create","UA-78267963-1","auto"),ga("send","pageview")</script></body></html>