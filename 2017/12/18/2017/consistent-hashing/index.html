<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="theme-color" content="#202020"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="keywords" content="Hash,Cache,分布式,算法,"><meta name="description" content="一致性Hash算法（Consistent Hashing）"><link rel="icon" type="image/x-icon" href="/logo.png"><title>一致性Hash算法（Consistent Hashing） [ 大新闻 ]</title><link rel="stylesheet" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" href="/css/microb.css"></head><body><nav class="home-menu pure-menu pure-menu-horizontal pure-menu-fixed"><ul class="pure-menu-list float-r clearfix"><li class="pure-menu-item toc-menu"><a id="menu-main-post" class="pure-menu-link" href="javascript:;"><img class="menu-icon" src="/logo.png" alt="MENU"></a></li></ul><a class="pure-menu-heading" href="/"><h1 class="title">大新闻</h1></a></nav><div class="container" id="content-outer"><div class="inner" id="content-inner"><article class="post" id="post"><header class="post-header text-center"><h1 class="title">一致性Hash算法（Consistent Hashing）</h1><time class="time" datetime="2017-12-18T02:48:51.000Z">2017-12-18</time><hr></header><div class="post-content"><p>本文主要翻译自：<a href="https://www.codeproject.com/Articles/56138/Consistent-hashing" target="_blank" rel="noopener">https://www.codeproject.com/Articles/56138/Consistent-hashing</a></p><h2 id="1-问题提出"><a href="#1-问题提出" class="headerlink" title="1. 问题提出"></a>1. 问题提出</h2><p>Hash算法经常出现在如分布式缓存，负载均衡等场景中，典型的算法是对N取余：</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">key = hash(value) % N</span><br></pre></td></tr></table></figure><p><a href="https://zh.wikipedia.org/w/index.php?title=David_Karger&amp;action=edit&amp;redlink=1" target="_blank" rel="noopener">David Karger</a>及其合作者列出了使得一致哈希在互联网分布式缓存中非常有用的几个特性： <a href="https://zh.wikipedia.org/wiki/%E4%B8%80%E8%87%B4%E5%93%88%E5%B8%8C#cite_note-KargerEtAl1997-1" target="_blank" rel="noopener">[1]</a></p><ul><li>冗余少</li><li>负载均衡</li><li>过渡平滑</li><li>存储均衡</li><li>关键词单调</li></ul><p>假设，当前有3台Cache Server，</p><ul><li>在考前流量集中，需要增加2台Server，key = hash(value) % 5</li><li>在考中一台Server挂掉，key = hash(value) % 4</li></ul><p>这意味这，在这些场景中，大部分缓存都将失效。缓存单调性无法满足，过渡也不平滑。</p><h2 id="2-解决方案"><a href="#2-解决方案" class="headerlink" title="2. 解决方案"></a>2. 解决方案</h2><h3 id="2-1-一致性hash算法"><a href="#2-1-一致性hash算法" class="headerlink" title="2.1 一致性hash算法"></a>2.1 一致性hash算法</h3><p>一致性hash算法采用环形Hash，把key hash到2^32个位置组成一个环。</p><p><img src="circle.jpg" alt=""></p><p>现在考虑有object1-obejct4，使用一致性hash算法，让key1-key4落在圆环上。</p><p><img src="object.jpg" alt=""></p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">hash(object1) = key1</span><br><span class="line">hash(object2) = key2</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>让key找到cache节点：让key1顺时针查找，找到最近的cacheA，以此类推。</p><p><img src="cache.jpg" alt=""></p><h3 id="2-2-考虑Cache挂掉的情况"><a href="#2-2-考虑Cache挂掉的情况" class="headerlink" title="2.2 考虑Cache挂掉的情况"></a>2.2 考虑Cache挂掉的情况</h3><p>如果现在Cache B挂了，落在Cache B上的节点是object4，只需要把object4顺时针映射到Cache C上即可，其他节点无需变动。理想情况下Cache C需要承受2N的流量。</p><p><img src="remove.jpg" alt=""></p><h3 id="2-3-考虑Cache增加的情况"><a href="#2-3-考虑Cache增加的情况" class="headerlink" title="2.3 考虑Cache增加的情况"></a>2.3 考虑Cache增加的情况</h3><p>增加一个Cache D。object2按照顺时针找到Cache D，其他节点也无需变动。</p><p><img src="add.jpg" alt=""></p><h2 id="3-优化"><a href="#3-优化" class="headerlink" title="3. 优化"></a>3. 优化</h2><p>上面解决了一致性的问题。但是Cache还不够平衡。为了解决平衡问题，引入了虚拟节点（Vitural Nodes）。在圆环上不是实际的Cache Node，而是把一个Cache分为多个虚拟Node，通过增加Cache Vitural Node来平衡增加或删除Cache的影响。</p><p><img src="virtual.jpg" alt=""></p><p>通过增加一部虚拟Node到真实Node的映射，达到更平衡的hash.</p><figure class="highlight"><table><tr><td class="code"><pre><span class="line">objec1-&gt;cache A2; objec2-&gt;cache A1; objec3-&gt;cache C1; objec4-&gt;cache C2</span><br></pre></td></tr></table></figure><p><img src="map.jpg" alt=""></p><h2 id="4-参考文档"><a href="#4-参考文档" class="headerlink" title="4. 参考文档"></a>4. 参考文档</h2><ul><li><a href="https://www.akamai.com/us/en/multimedia/documents/technical-publication/consistent-hashing-and-random-trees-distributed-caching-protocols-for-relieving-hot-spots-on-the-world-wide-web-technical-publication.pdf" target="_blank" rel="noopener">https://www.akamai.com/us/en/multimedia/documents/technical-publication/consistent-hashing-and-random-trees-distributed-caching-protocols-for-relieving-hot-spots-on-the-world-wide-web-technical-publication.pdf</a></li><li><a href="http://www.jianshu.com/p/e8fb89bb3a61#" target="_blank" rel="noopener">http://www.jianshu.com/p/e8fb89bb3a61#</a></li><li><a href="http://www.zsythink.net/archives/1182" target="_blank" rel="noopener">http://www.zsythink.net/archives/1182</a></li><li><a href="https://www.codeproject.com/Articles/56138/Consistent-hashing" target="_blank" rel="noopener">https://www.codeproject.com/Articles/56138/Consistent-hashing</a></li><li><a href="https://zh.wikipedia.org/wiki/%E4%B8%80%E8%87%B4%E5%93%88%E5%B8%8C" target="_blank" rel="noopener">https://zh.wikipedia.org/wiki/%E4%B8%80%E8%87%B4%E5%93%88%E5%B8%8C</a></li></ul></div><div class="post-tags"><ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Cache/">Cache</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Hash/">Hash</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/分布式/">分布式</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/算法/">算法</a></li></ul></div></article><div class="post-nav"><div class="post-nav-item post-nav-next"><a href="/2017/12/15/2017/mongodb-upgrade-to-3-6-0/" rel="next" title="MongoDB从3.2升级到3.6的二三事"><span>〈 </span>MongoDB从3.2升级到3.6的二三事</a></div><div class="post-nav-item post-nav-prev"><a href="/2017/12/18/2017/mysql-tips/" rel="prev" title="MySQL性能优化技巧">MySQL性能优化技巧 <span>〉</span></a></div></div><div id="toc" class="toc-article"><strong class="toc-title">目录</strong><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-问题提出"><span class="toc-text">1. 问题提出</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-解决方案"><span class="toc-text">2. 解决方案</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-一致性hash算法"><span class="toc-text">2.1 一致性hash算法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-考虑Cache挂掉的情况"><span class="toc-text">2.2 考虑Cache挂掉的情况</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-考虑Cache增加的情况"><span class="toc-text">2.3 考虑Cache增加的情况</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-优化"><span class="toc-text">3. 优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-参考文档"><span class="toc-text">4. 参考文档</span></a></li></ol></div></div></div><footer class="footer text-center"><div id="bottom-inner"><a href="http://hexo.io" target="_blank" class="footer-link">Hexo</a> <a href="https://github.com/microacup/hexo-theme-micorb" target="_blank" class="footer-link">Theme microb</a></div></footer><script>var titleTime,originTitle=document.title;document.addEventListener("visibilitychange",function(){document.hidden?(document.title="[闷声发大财中...] "+originTitle,clearTimeout(titleTime)):(document.title="[+1s] "+originTitle,titleTime=setTimeout(function(){document.title=originTitle},2e3))})</script><script>!function(e,t){e.requestAnimationFrame=e.requestAnimationFrame||e.webkitRequestAnimationFrame||e.mozRequestAnimationFrame||e.oRequestAnimationFrame||e.msRequestAnimationFrame||function(e){setTimeout(e,1e3/60)},function(){var e=t.getElementById("menu-main-post");if(e){var n=t.getElementById("toc");e.title=n?"目录":"回到顶部",e.onclick=function(){n?"block"==n.style.display?n.style.display="none":n.style.display="block":(cancelAnimationFrame(o),o=requestAnimationFrame(function e(){var n=t.body.scrollTop||t.documentElement.scrollTop;0<n?(t.body.scrollTop=t.documentElement.scrollTop=n-50,o=requestAnimationFrame(e)):cancelAnimationFrame(o)}))}}}();var o=null}(window,document)</script><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?b6d76ecb62c0651d8e5b7f7085f443f1";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script>!function(e,a,t,n,g,c,o){e.GoogleAnalyticsObject="ga",e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=1*new Date,c=a.createElement(t),o=a.getElementsByTagName(t)[0],c.async=1,c.src="//www.google-analytics.com/analytics.js",o.parentNode.insertBefore(c,o)}(window,document,"script"),ga("create","UA-78267963-1","auto"),ga("send","pageview")</script></body></html>