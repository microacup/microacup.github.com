<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="theme-color" content="#202020"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="keywords" content="Node.js,MongoDB,mongoose,"><meta name="description" content="mongoose使用aggregate实现按照日期分组统计"><link rel="icon" type="image/x-icon" href="/logo.png"><title>mongoose使用aggregate实现按照日期分组统计 [ 大新闻 ]</title><link rel="stylesheet" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" href="/css/microb.css"></head><body><nav class="home-menu pure-menu pure-menu-horizontal pure-menu-fixed"><ul class="pure-menu-list float-r clearfix"><li class="pure-menu-item toc-menu"><a id="menu-main-post" class="pure-menu-link" href="javascript:;"><img class="menu-icon" src="/logo.png" alt="MENU"></a></li></ul><a class="pure-menu-heading" href="/"><h1 class="title">大新闻</h1></a></nav><div class="container" id="content-outer"><div class="inner" id="content-inner"><article class="post" id="post"><header class="post-header text-center"><h1 class="title">mongoose使用aggregate实现按照日期分组统计</h1><time class="time" datetime="2017-03-27T01:16:03.000Z">2017-03-27</time><hr></header><div class="post-content"><h2 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h2><p>统计最近N天的新增用户数量</p><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>很幸运，MongoDB提供了聚合函数aggregate来完成这个任务。</p><h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><h3 id="1-Model"><a href="#1-Model" class="headerlink" title="1. Model"></a>1. Model</h3><figure class="highlight"><table><tr><td class="code"><pre><span class="line">&#123;"_id" : 1, "createdTime" : ISODate("2017-03-07T06:40:58.337+0000"), ...&#125;,</span><br><span class="line">&#123;"_id" : 2, "createdTime" : ISODate("2017-03-08T06:40:58.337+0000"), ...&#125;,</span><br><span class="line">&#123;"_id" : 3, "createdTime" : ISODate("2017-03-09T06:40:58.337+0000"), ...&#125;</span><br></pre></td></tr></table></figure><h3 id="2-代码"><a href="#2-代码" class="headerlink" title="2. 代码"></a>2. 代码</h3><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">db.users.aggregate(</span><br><span class="line">	<span class="comment">// Pipeline</span></span><br><span class="line">	[</span><br><span class="line">		<span class="comment">// 符合这个条件的文档才被统计</span></span><br><span class="line">		&#123;</span><br><span class="line">			$match: &#123;</span><br><span class="line">			    <span class="string">"createdTime"</span>: &#123; <span class="attr">$gt</span>: ISODate(<span class="string">"2017-01-17T23:41:04.372+0000"</span>) &#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;,</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 定义一些字段，给后面的处理使用，排除、重命名和显示字段</span></span><br><span class="line">		&#123;</span><br><span class="line">          	$project: &#123;</span><br><span class="line">            	<span class="comment">// 时区数据校准，8小时换算成毫秒数为8*60*60*1000=288000后分割成YYYY-MM-DD日期格式便于分组</span></span><br><span class="line">				day1 : &#123;<span class="attr">$substr</span>: [&#123;<span class="string">"$add"</span>:[<span class="string">"$createdTime"</span>, <span class="number">28800000</span>]&#125;, <span class="number">0</span>, <span class="number">10</span>] &#125;</span><br><span class="line">				day2: &#123; <span class="attr">year</span>: &#123; <span class="attr">$year</span>: <span class="string">"$createdTime"</span> &#125;, <span class="attr">month</span>: &#123; <span class="attr">$month</span>: <span class="string">"$createdTime"</span> &#125;, <span class="attr">day</span>: &#123; <span class="attr">$dayOfMonth</span>: <span class="string">"$createdTime"</span>&#125; &#125;, <span class="comment">// 因为MongoDB的时区，直接使用这种方法的日期是不正确的</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;,</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 按照给定表达式组合结果</span></span><br><span class="line">		&#123;</span><br><span class="line">		  	$group: &#123;</span><br><span class="line">				_id: <span class="string">"$day1"</span>, <span class="comment">// 将_id设置为day数据</span></span><br><span class="line">				totalCount:&#123;<span class="attr">$sum</span>: <span class="number">1</span>&#125;, <span class="comment">// 统计count, 每条数据+1</span></span><br><span class="line">		  	&#125;</span><br><span class="line">		&#125;,</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 排序</span></span><br><span class="line">		&#123;</span><br><span class="line">		  	$sort: &#123;</span><br><span class="line">				_id: <span class="number">1</span></span><br><span class="line">      		&#125;</span><br><span class="line">		&#125;,</span><br><span class="line">	]</span><br><span class="line">);</span><br></pre></td></tr></table></figure><h3 id="3-说明"><a href="#3-说明" class="headerlink" title="3. 说明"></a>3. 说明</h3><ul><li>$match : 查询，需要同find()一样的参数</li><li>$project：包含、排除、重命名和显示字段</li><li>$group：按照给定表达式组合结果</li><li>$sort：按照给定的字段排序结果</li><li>$sum：总结从集合中的所有文件所定义的值。后面可以是一个字段，表示对这个字段累加，如果是常数，表示每次增加的数值。</li></ul><h3 id="4-返回结果"><a href="#4-返回结果" class="headerlink" title="4. 返回结果"></a>4. 返回结果</h3><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">[&#123;</span><br><span class="line">  <span class="attr">"_id"</span>: <span class="string">"2017-02-24"</span>,</span><br><span class="line">  <span class="attr">"totalCount"</span>: <span class="number">1</span></span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"_id"</span>: <span class="string">"2017-03-07"</span>,</span><br><span class="line">  <span class="attr">"totalCount"</span>: <span class="number">1</span></span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"_id"</span>: <span class="string">"2017-03-16"</span>,</span><br><span class="line">  <span class="attr">"totalCount"</span>: <span class="number">1</span></span><br><span class="line">&#125;]</span><br></pre></td></tr></table></figure><h3 id="5-效果"><a href="#5-效果" class="headerlink" title="5. 效果"></a>5. 效果</h3><p><img src="1.jpg" alt=""></p><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><ul><li>mongoose ^4.7.5</li><li>Node.js ^7.0.0</li><li>DEBUG:<ul><li>Studio 3T for MongoDB</li></ul></li></ul><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a href="https://docs.mongodb.com/manual/reference/operator/aggregation/sum/" target="_blank" rel="noopener">https://docs.mongodb.com/manual/reference/operator/aggregation/sum/</a></li><li><a href="https://docs.mongodb.com/manual/reference/operator/aggregation-date/" target="_blank" rel="noopener">https://docs.mongodb.com/manual/reference/operator/aggregation-date/</a></li><li><a href="http://www.fidding.me/article/25" target="_blank" rel="noopener">http://www.fidding.me/article/25</a></li><li><a href="http://blog.csdn.net/orangleliu/article/details/39932081" target="_blank" rel="noopener">http://blog.csdn.net/orangleliu/article/details/39932081</a></li></ul></div><div class="post-tags"><ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MongoDB/">MongoDB</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Node-js/">Node.js</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mongoose/">mongoose</a></li></ul></div></article><div class="post-nav"><div class="post-nav-item post-nav-next"><a href="/2017/03/17/2017/node-run-pm2-in-production-env/" rel="next" title="在生产环境中使用PM2运行Node"><span>〈 </span>在生产环境中使用PM2运行Node</a></div><div class="post-nav-item post-nav-prev"><a href="/2017/04/11/2017/multer-koa-md5-upload/" rel="prev" title="koa使用multer上传实现以文件hash(md5)作为文件名附文件秒传原理">koa使用multer上传实现以文件hash(md5)作为文件名附文件秒传原理 <span>〉</span></a></div></div><div id="toc" class="toc-article"><strong class="toc-title">目录</strong><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#需求"><span class="toc-text">需求</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#分析"><span class="toc-text">分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#实现"><span class="toc-text">实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Model"><span class="toc-text">1. Model</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-代码"><span class="toc-text">2. 代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-说明"><span class="toc-text">3. 说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-返回结果"><span class="toc-text">4. 返回结果</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-效果"><span class="toc-text">5. 效果</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#环境"><span class="toc-text">环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考"><span class="toc-text">参考</span></a></li></ol></div></div></div><footer class="footer text-center"><div id="bottom-inner"><a href="http://hexo.io" target="_blank" class="footer-link">Hexo</a> <a href="https://github.com/microacup/hexo-theme-micorb" target="_blank" class="footer-link">Theme microb</a></div></footer><script>var titleTime,originTitle=document.title;document.addEventListener("visibilitychange",function(){document.hidden?(document.title="[闷声发大财中...] "+originTitle,clearTimeout(titleTime)):(document.title="[+1s] "+originTitle,titleTime=setTimeout(function(){document.title=originTitle},2e3))})</script><script>!function(e,t){e.requestAnimationFrame=e.requestAnimationFrame||e.webkitRequestAnimationFrame||e.mozRequestAnimationFrame||e.oRequestAnimationFrame||e.msRequestAnimationFrame||function(e){setTimeout(e,1e3/60)},function(){var e=t.getElementById("menu-main-post");if(e){var n=t.getElementById("toc");e.title=n?"目录":"回到顶部",e.onclick=function(){n?"block"==n.style.display?n.style.display="none":n.style.display="block":(cancelAnimationFrame(o),o=requestAnimationFrame(function e(){var n=t.body.scrollTop||t.documentElement.scrollTop;0<n?(t.body.scrollTop=t.documentElement.scrollTop=n-50,o=requestAnimationFrame(e)):cancelAnimationFrame(o)}))}}}();var o=null}(window,document)</script><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?b6d76ecb62c0651d8e5b7f7085f443f1";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script>!function(e,a,t,n,g,c,o){e.GoogleAnalyticsObject="ga",e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=1*new Date,c=a.createElement(t),o=a.getElementsByTagName(t)[0],c.async=1,c.src="//www.google-analytics.com/analytics.js",o.parentNode.insertBefore(c,o)}(window,document,"script"),ga("create","UA-78267963-1","auto"),ga("send","pageview")</script></body></html>