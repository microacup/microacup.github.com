<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="theme-color" content="#202020"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="keywords" content="HTTP,Restful,手册,"><meta name="description" content="Restful从入门到放弃-关于Patch不是幂等的想到的"><link rel="icon" type="image/x-icon" href="/logo.png"><title>Restful从入门到放弃-关于Patch不是幂等的想到的 [ 大新闻 ]</title><link rel="stylesheet" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" href="/css/microb.css"></head><body><nav class="home-menu pure-menu pure-menu-horizontal pure-menu-fixed"><ul class="pure-menu-list float-r clearfix"><li class="pure-menu-item toc-menu"><a id="menu-main-post" class="pure-menu-link" href="javascript:;"><img class="menu-icon" src="/logo.png" alt="MENU"></a></li></ul><a class="pure-menu-heading" href="/"><h1 class="title">大新闻</h1></a></nav><div class="container" id="content-outer"><div class="inner" id="content-inner"><article class="post" id="post"><header class="post-header text-center"><h1 class="title">Restful从入门到放弃-关于Patch不是幂等的想到的</h1><time class="time" datetime="2016-12-27T02:28:35.000Z">2016-12-27</time><hr></header><div class="post-content"><h2 id="HTTP-Method"><a href="#HTTP-Method" class="headerlink" title="HTTP Method"></a>HTTP Method</h2><p>首先回顾一下在Restful的API中，我们用到的HTTP方法：</p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">GET     /blogs       # 获取blog列表</div><div class="line">GET     /blogs/12    # 查看某个具体的blog</div><div class="line">POST    /blogs       # 新建一个blog</div><div class="line">PUT     /blogs/12    # 更新blog 12</div><div class="line">PATCH   /blogs/12    # 更新blog 12</div><div class="line">DELETE  /blogs/12    # 删除ticekt 12</div></pre></td></tr></table></figure><p>我们注意到<strong>更新</strong>操作，有两个方法可以做到：<code>PUT</code>和<code>PATCH</code>， 那么它们有什么区别呢？</p><h2 id="PUT-or-PATCH"><a href="#PUT-or-PATCH" class="headerlink" title="PUT or PATCH"></a>PUT or PATCH</h2><p>PATCH比PUT更年轻，在2010年才成为<a href="https://tools.ietf.org/html/rfc5789" target="_blank" rel="external">正式的标准</a>，有关于它的介绍中说道，它被用来局部更新某个资源，举个例子：</p><figure class="highlight json"><table><tr><td class="code"><pre><div class="line">PATCH   /users/1    # 更新user 1</div><div class="line">&#123;</div><div class="line">  <span class="attr">"nick"</span>: <span class="string">"王蛋蛋"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure><p>把用户<code>ID=1</code>的昵称改为王蛋蛋。它和<code>PUT</code>的区别就在于，<code>PUT</code>必须提供全量的user属性替换原有的服务器资源。而<code>PATCH</code>只会更新提供的字段。</p><p>假如user中还有一个version字段用来记录版本，每次PATCH，<code>version++</code>。正因为这样的<strong>不可控性</strong> ，所以<code>PATCH</code>被定义为<strong>可能</strong>是非幂等（idempotent ）的。</p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">The difference between the PUT and PATCH requests is reflected in the</div><div class="line">way the server processes the enclosed entity to modify the resource</div><div class="line">identified by the Request-URI.  In a PUT request, the enclosed entity</div><div class="line">is considered to be a modified version of the resource stored on the</div><div class="line">origin server, and the client is requesting that the stored version</div><div class="line">be replaced.  With PATCH, however, the enclosed entity contains a set</div><div class="line">of instructions describing how a resource currently residing on the</div><div class="line">origin server should be modified to produce a new version.  The PATCH</div><div class="line">method affects the resource identified by the Request-URI, and it</div><div class="line">also MAY have side effects on other resources; i.e., new resources</div><div class="line">may be created, or existing ones modified, by the application of a</div><div class="line">PATCH.</div><div class="line"></div><div class="line">PATCH is neither safe nor idempotent as defined by [RFC2616], Section 9.1.</div></pre></td></tr></table></figure><p>所以，如果是需要全部更新属性，那就是用PUT，如果是局部更新，为了节约带宽，请使用PATCH。在接下来的Restful api设计中，还会提到为什么github不使用PATCH。</p><h2 id="关于幂等"><a href="#关于幂等" class="headerlink" title="关于幂等"></a>关于幂等</h2><h3 id="哪些叫幂等或-且安全的方法？"><a href="#哪些叫幂等或-且安全的方法？" class="headerlink" title="哪些叫幂等或/且安全的方法？"></a>哪些叫幂等或/且安全的方法？</h3><p>安全方法是指<strong>不修改资源</strong>的 HTTP 方法。譬如，当使用 GET 或者 HEAD 作为资源 URL，都必须不去改变资源。然而，这并不全准确。意思是：它不改变资源的 表示形式。对于安全方法，它仍然可能改变服务器上的内容或资源，但这必须不导致不同的表现形式。</p><p><strong>HTTP 幂等方法是指无论调用多少次都不会有不同结果的 HTTP 方法。它无论是调用一次，还是N次都无关紧要。结果仍应相同。</strong>再次强调， 它只作用于结果而非资源本身。它仍可能被操纵（如一个更新的 timestamp），提供这一信息并不影响（当前）资源的表现形式。</p><p>例如：GET当前时间是幂等的，虽然每次获取的结果不同，但它并没有改变时间这个资源本身，而是只读。所以结果总是一个时间戳。表示形式没有被改变。</p><figure class="highlight"><table><tr><td class="code"><pre><div class="line">GET /time # 获取当前时间</div></pre></td></tr></table></figure><h3 id="还有哪些方法不是幂等的呢？"><a href="#还有哪些方法不是幂等的呢？" class="headerlink" title="还有哪些方法不是幂等的呢？"></a>还有哪些方法不是幂等的呢？</h3><table><thead><tr><th>HTTP Method</th><th>Idempotent</th><th>Safe</th></tr></thead><tbody><tr><td>OPTIONS</td><td>yes</td><td>yes</td></tr><tr><td>GET</td><td>yes</td><td>yes</td></tr><tr><td>HEAD</td><td>yes</td><td>yes</td></tr><tr><td>PUT</td><td>yes</td><td>no</td></tr><tr><td>POST<em>**</em></td><td><strong>no</strong></td><td>no</td></tr><tr><td>DELETE</td><td>yes</td><td>no</td></tr><tr><td>PATCH</td><td><strong>no</strong></td><td>no</td></tr></tbody></table><p>可以看到，只有POST和PATCH是非幂等的。</p><h2 id="Restful-API建议"><a href="#Restful-API建议" class="headerlink" title="Restful API建议"></a>Restful API建议</h2><p>在构建Restful API时，建议：</p><ul><li><p>一个 API 实现 [PATCH] 必须是原子的。它一定不能出现只 [GET] 到被 [PATCH] 更新了一半的资源。如果不能做到用PUT代替。</p></li><li><p>明确告诉调用者，API的副作用，是否幂等，以免不必要的疑惑。</p><p>​</p></li></ul><h2 id="题外话"><a href="#题外话" class="headerlink" title="题外话"></a>题外话</h2><p>在<a href="https://developer.github.com/v3/#http-verbs" target="_blank" rel="external">Github Api</a>中，使用了Post代替了Patch，它是这么说的：</p><table><thead><tr><th>Verb</th><th>Description</th></tr></thead><tbody><tr><td><code>HEAD</code></td><td>Can be issued against any resource to get just the HTTP header info.</td></tr><tr><td><code>GET</code></td><td>Used for retrieving resources.</td></tr><tr><td><code>POST</code></td><td>Used for creating resources.</td></tr><tr><td><code>PATCH</code></td><td>Used for updating resources with partial JSON data. For instance, an Issue resource has <code>title</code> and <code>body</code> attributes. A PATCH request may accept one or more of the attributes to update the resource. PATCH is a relatively new and uncommon HTTP verb, so resource endpoints also accept <code>POST</code> requests.</td></tr><tr><td><code>PUT</code></td><td>Used for replacing resources or collections. For <code>PUT</code> requests with no <code>body</code> attribute, be sure to set the <code>Content-Length</code> header to zero.</td></tr><tr><td><code>DELETE</code></td><td>Used for deleting resources.</td></tr></tbody></table><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a href="http://sofish.github.io/restcookbook/" target="_blank" rel="external">RESTful 手册</a></li><li><a href="http://blog.720ui.com/2016/restful_idempotent/" target="_blank" rel="external">如何理解RESTful的幂等性</a></li><li><a href="https://tools.ietf.org/html/rfc5789" target="_blank" rel="external"><a href="http://tools.ietf.org/html/rfc5789" target="_blank" rel="external">RFC 5789 - HTTP PATCH</a></a></li><li><a href="https://ihower.tw/blog/archives/6483" target="_blank" rel="external">HTTP Verbs: 談 POST, PUT 和 PATCH 的應用</a></li></ul></div><div class="post-tags"><ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/HTTP/">HTTP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Restful/">Restful</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/手册/">手册</a></li></ul></div></article><div class="post-nav"><div class="post-nav-item post-nav-next"><a href="/2016/12/23/2016/es6/" rel="next" title="ES6/ES7参考手册"><span>〈 </span>ES6/ES7参考手册</a></div><div class="post-nav-item post-nav-prev"><a href="/2017/01/10/2017/node-sass-called-fsevents-install-error/" rel="prev" title="解决node-sass-called-fsevents-install-error">解决node-sass-called-fsevents-install-error <span>〉</span></a></div></div><div id="toc" class="toc-article"><strong class="toc-title">目录</strong><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#HTTP-Method"><span class="toc-text">HTTP Method</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PUT-or-PATCH"><span class="toc-text">PUT or PATCH</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#关于幂等"><span class="toc-text">关于幂等</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#哪些叫幂等或-且安全的方法？"><span class="toc-text">哪些叫幂等或/且安全的方法？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#还有哪些方法不是幂等的呢？"><span class="toc-text">还有哪些方法不是幂等的呢？</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Restful-API建议"><span class="toc-text">Restful API建议</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#题外话"><span class="toc-text">题外话</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考"><span class="toc-text">参考</span></a></li></ol></div></div></div><footer class="footer text-center"><div id="bottom-inner"><a href="http://hexo.io" target="_blank" class="footer-link">Hexo</a> <a href="https://github.com/microacup/hexo-theme-micorb" target="_blank" class="footer-link">Theme microb</a></div></footer><script>var titleTime,originTitle=document.title;document.addEventListener("visibilitychange",function(){document.hidden?(document.title="[闷声发大财中...] "+originTitle,clearTimeout(titleTime)):(document.title="[+1s] "+originTitle,titleTime=setTimeout(function(){document.title=originTitle},2e3))})</script><script>!function(n,e){!function(){var n=e.getElementById("menu-main-post");if(n){var t=e.getElementById("toc");t?n.onclick=function(){t&&("block"==t.style.display?t.style.display="none":t.style.display="block")}:n.style.display="none"}}()}(window,document)</script><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?b6d76ecb62c0651d8e5b7f7085f443f1";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script>!function(e,a,t,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=a.createElement(t),s=a.getElementsByTagName(t)[0],o.async=1,o.src="//www.google-analytics.com/analytics.js",s.parentNode.insertBefore(o,s)}(window,document,"script",0,"ga"),ga("create","UA-78267963-1","auto"),ga("send","pageview")</script></body></html>