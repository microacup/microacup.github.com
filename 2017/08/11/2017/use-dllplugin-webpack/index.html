<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="theme-color" content="#202020"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="keywords" content="Vue,Webpack,"><meta name="description" content="Webpack使用DllPlugin加速打包，并自动插入html"><link rel="icon" type="image/x-icon" href="/logo.png"><title>Webpack使用DllPlugin加速打包，并自动插入html [ 大新闻 ]</title><link rel="stylesheet" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" href="/css/microb.css"></head><body><nav class="home-menu pure-menu pure-menu-horizontal pure-menu-fixed"><ul class="pure-menu-list float-r clearfix"><li class="pure-menu-item toc-menu"><a id="menu-main-post" class="pure-menu-link" href="javascript:;"><img class="menu-icon" src="/logo.png" alt="MENU"></a></li></ul><a class="pure-menu-heading" href="/"><h1 class="title">大新闻</h1></a></nav><div class="container" id="content-outer"><div class="inner" id="content-inner"><article class="post" id="post"><header class="post-header text-center"><h1 class="title">Webpack使用DllPlugin加速打包，并自动插入html</h1><time class="time" datetime="2017-08-11T07:39:19.000Z">2017-08-11</time><hr></header><div class="post-content"><blockquote><p>本文将指导如何使用 <code>DllPlugin</code> 加速 <code>webpack</code> 构建。</p></blockquote><a id="more"></a><h2 id="为什么"><a href="#为什么" class="headerlink" title="为什么"></a>为什么</h2><p>在 <code>Vue-webpack-multi</code> 工程中，如果想抽出公共部分，可以使用 CommonsChunk 插件完成。它会把 vue 等公共部分打包为 vendor，每个页面引入 vendor.js。但依然会存在一些问题：</p><ul><li>每次 build 会打包 vendor，耗时</li><li>有些 module 更新缓慢，有些 module 更新频繁，导致客户端经常下载很大的 vendor.js</li></ul><p>那么，如果有上述问题，可以引入 DllPlugin 抽出那些公用的，更新频度低的模块。思路类似与 windows 的 dll 文件。</p><h2 id="怎么做"><a href="#怎么做" class="headerlink" title="怎么做"></a>怎么做</h2><p>1、添加 webpack.dll.config.js 文件，这一步是为了告诉 DllPlugin 哪些文件需要抽出来，以及生成 manifest.json 配置文件。</p><figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">"path"</span>);</div><div class="line"><span class="keyword">const</span> webpack = <span class="built_in">require</span>(<span class="string">"webpack"</span>);</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = &#123;</div><div class="line">  <span class="comment">// 这里是哪些module需要抽出来</span></div><div class="line">  entry: &#123;</div><div class="line">    vendor: [<span class="string">"vue-router"</span>, <span class="string">"vuex"</span>, <span class="string">"fastclick"</span>, <span class="string">"axios"</span>]</div><div class="line">  &#125;,</div><div class="line">  output: &#123;</div><div class="line">    path: path.join(__dirname, <span class="string">"../static/js"</span>),</div><div class="line">    filename: <span class="string">"[name].dll.js"</span>,</div><div class="line">    library: <span class="string">"[name]_library"</span></div><div class="line">  &#125;,</div><div class="line">  plugins: [</div><div class="line">    <span class="keyword">new</span> webpack.DllPlugin(&#123;</div><div class="line">      path: path.join(__dirname, <span class="string">"."</span>, <span class="string">"[name]-manifest.json"</span>),</div><div class="line">      name: <span class="string">"[name]_library"</span></div><div class="line">    &#125;),</div><div class="line">    <span class="keyword">new</span> webpack.optimize.UglifyJsPlugin(&#123;</div><div class="line">      compress: &#123;</div><div class="line">        warnings: <span class="literal">false</span></div><div class="line">      &#125;</div><div class="line">    &#125;),</div><div class="line">    <span class="keyword">new</span> webpack.DefinePlugin(&#123;</div><div class="line">      <span class="string">"process.env"</span>: &#123;</div><div class="line">        NODE_ENV: <span class="string">'"production"'</span></div><div class="line">      &#125;</div><div class="line">    &#125;)</div><div class="line">  ]</div><div class="line">&#125;;</div></pre></td></tr></table></figure><p>2、在 webpack.prod.config.js 文件中添加引用：DllReferencePlugin</p><figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line">plugins: [</div><div class="line">  <span class="comment">// ...</span></div><div class="line"></div><div class="line">  <span class="comment">// 加入插件，让webpack使用dll</span></div><div class="line">  <span class="keyword">new</span> webpack.DllReferencePlugin(&#123;</div><div class="line">    context: path.resolve(__dirname, <span class="string">".."</span>),</div><div class="line">    manifest: <span class="built_in">require</span>(<span class="string">"./vendor-manifest.json"</span>)</div><div class="line">  &#125;)</div><div class="line"></div><div class="line">  <span class="comment">// ...</span></div><div class="line">];</div></pre></td></tr></table></figure><p>3、在 package.json 文件中加入 scripts：</p><figure class="highlight"><table><tr><td class="code"><pre><div class="line">"build:dll": "webpack --config build/webpack.dll.conf.js --progress",</div></pre></td></tr></table></figure><p>4、运行：</p><figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">npm run build:dll</div></pre></td></tr></table></figure><p>会在 static/js 目录下生成 vendor.dll.js。到此可以把文件加入 html 文件使用了。</p><p>5、更进一步</p><p>是的，以上配置并不会在 html 中自动插入 vendor.dll.js。那么，我们还需要另一个插件 AddAssetHtmlPlugin 来完成这个任务。</p><ul><li><p>首先引入依赖</p><figure class="highlight shell"><table><tr><td class="code"><pre><div class="line">npm i add-asset-html-webpack-plugin -D</div></pre></td></tr></table></figure></li><li><p>在 webpack.prod.config.js 文件中添加引用：AddAssetHtmlPlugin</p><figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line">plugins: [</div><div class="line">  <span class="comment">// ...</span></div><div class="line">  <span class="comment">// 加入插件，让webpack使用dll</span></div><div class="line">  <span class="keyword">new</span> webpack.DllReferencePlugin(&#123;</div><div class="line">    context: path.resolve(__dirname, <span class="string">".."</span>),</div><div class="line">    manifest: <span class="built_in">require</span>(<span class="string">"./vendor-manifest.json"</span>)</div><div class="line">  &#125;),</div><div class="line">  <span class="comment">// 复制公共dll.js，并插入html</span></div><div class="line">  <span class="keyword">new</span> AddAssetHtmlPlugin([</div><div class="line">    &#123;</div><div class="line">      filepath: path.resolve(__dirname, <span class="string">"../static/js/vendor.dll.js"</span>), <span class="comment">// 同webpack.dll.conf.js output</span></div><div class="line">      outputPath: utils.assetsPath(<span class="string">"js"</span>),</div><div class="line">      publicPath: path.posix.join(config.build.assetsPublicPath, <span class="string">"static/js"</span>),</div><div class="line">      includeSourcemap: <span class="literal">false</span>,</div><div class="line">      hash: <span class="literal">true</span></div><div class="line">    &#125;</div><div class="line">  ])</div><div class="line">  <span class="comment">// ...</span></div><div class="line">];</div></pre></td></tr></table></figure><p>这时，再次运行</p><figure class="highlight shell"><table><tr><td class="code"><pre><div class="line">npm run build</div></pre></td></tr></table></figure><p>html 已自动引入 vendor.dll.js。</p><figure class="highlight html"><table><tr><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"/live/static/js/vendor.dll.js?9052a4023ee8f3900f3a"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"/live/static/js/vendor.9da0e0be7a97a0e0034e.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"/live/static/js/embed/room.eb30321a94ba3c461902.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div></pre></td></tr></table></figure><p>​</p></li></ul><p>参考：</p><ul><li><a href="https://npm.taobao.org/package/add-asset-html-webpack-plugin" target="_blank" rel="external">https://npm.taobao.org/package/add-asset-html-webpack-plugin</a></li><li><a href="https://segmentfault.com/a/1190000005969643" target="_blank" rel="external">https://segmentfault.com/a/1190000005969643</a></li></ul></div><div class="post-tags"><ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Vue/">Vue</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Webpack/">Webpack</a></li></ul></div></article><div class="post-nav"><div class="post-nav-item post-nav-next"><a href="/2017/08/07/2017/socket-io/" rel="next" title="socket.io常见问题"><span>〈 </span>socket.io常见问题</a></div><div class="post-nav-item post-nav-prev"><a href="/2017/08/25/2017/chrome-localhost-6000-err-unsafe-port/" rel="prev" title="关于Chrome访问6000等端口报ERR_UNSAFE_PORT的问题">关于Chrome访问6000等端口报ERR_UNSAFE_PORT的问题 <span>〉</span></a></div></div><div id="toc" class="toc-article"><strong class="toc-title">目录</strong><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#为什么"><span class="toc-text">为什么</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#怎么做"><span class="toc-text">怎么做</span></a></li></ol></div></div></div><footer class="footer text-center"><div id="bottom-inner"><a href="http://hexo.io" target="_blank" class="footer-link">Hexo</a> <a href="https://github.com/microacup/hexo-theme-micorb" target="_blank" class="footer-link">Theme microb</a></div></footer><script>var titleTime,originTitle=document.title;document.addEventListener("visibilitychange",function(){document.hidden?(document.title="[闷声发大财中...] "+originTitle,clearTimeout(titleTime)):(document.title="[+1s] "+originTitle,titleTime=setTimeout(function(){document.title=originTitle},2e3))})</script><script>!function(n,e){!function(){var n=e.getElementById("menu-main-post");if(n){var t=e.getElementById("toc");t?n.onclick=function(){t&&("block"==t.style.display?t.style.display="none":t.style.display="block")}:n.style.display="none"}}()}(window,document)</script><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?b6d76ecb62c0651d8e5b7f7085f443f1";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script>!function(e,a,t,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=a.createElement(t),s=a.getElementsByTagName(t)[0],o.async=1,o.src="//www.google-analytics.com/analytics.js",s.parentNode.insertBefore(o,s)}(window,document,"script",0,"ga"),ga("create","UA-78267963-1","auto"),ga("send","pageview")</script></body></html>