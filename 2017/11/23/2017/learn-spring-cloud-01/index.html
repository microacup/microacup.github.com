<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="theme-color" content="#202020"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="keywords" content="Spring,Spring Cloud,微服务,"><meta name="description" content="学习Spring Cloud：Discovery"><link rel="icon" type="image/x-icon" href="/logo.png"><title>学习Spring Cloud：Discovery [ 大新闻 ]</title><link rel="stylesheet" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" href="/css/microb.css"></head><body><nav class="home-menu pure-menu pure-menu-horizontal pure-menu-fixed"><ul class="pure-menu-list float-r clearfix"><li class="pure-menu-item toc-menu"><a id="menu-main-post" class="pure-menu-link" href="javascript:;"><img class="menu-icon" src="/logo.png" alt="MENU"></a></li></ul><a class="pure-menu-heading" href="/"><h1 class="title">大新闻</h1></a></nav><div class="container" id="content-outer"><div class="inner" id="content-inner"><article class="post" id="post"><header class="post-header text-center"><h1 class="title">学习Spring Cloud：Discovery</h1><time class="time" datetime="2017-11-23T02:38:56.000Z">2017-11-23</time><hr></header><div class="post-content"><p>使用 Spring Cloud 服务中心可能遇到的的一些问题。</p><a id="more"></a><h2 id="服务中心"><a href="#服务中心" class="headerlink" title="服务中心"></a>服务中心</h2><p><strong>服务中心</strong>：Discovery，管理各种服务功能包括服务的注册、发现、熔断、负载、降级等。</p><p><strong>解决的问题</strong>：<strong>大量</strong>服务间的相互依赖关系改为由服务中心统一管理。符合低解耦特性。</p><p><strong>例如</strong>：Ａ依赖Ｂ依赖Ｃ. B 和 C 是具体服务的提供方，Ａ-&gt;B-&gt;C 依赖关系改为</p><ul><li>A(Discovery Client) -&gt;Discovery Server -&gt;B(Discovery Client)</li></ul><ul><li>B(Discovery Client) -&gt;Discovery Server -&gt;C(Discovery Client)</li></ul><p><img src="eureka-architecture-overview.png" alt=""></p><h2 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h2><h3 id="1-保护模式"><a href="#1-保护模式" class="headerlink" title="1.保护模式"></a>1.保护模式</h3><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">EMERGENCY! EUREKA MAY BE INCORRECTLY CLAIMING INSTANCES ARE UP WHEN THEY&apos;RE NOT. </div><div class="line">RENEWALS ARE LESSER THAN THRESHOLD AND HENCE THE INSTANCES ARE NOT BEING EXPIRED JUST TO BE SAFE.</div></pre></td></tr></table></figure><p>Eureka server 和 client 之间每隔 30 秒会进行一次心跳通信，告诉 server，client 还活着。由此引出两个名词：<br>Renews threshold：server 期望在每分钟中收到的心跳次数<br>Renews (last min)：上一分钟内收到的心跳次数。</p><p>前文说到禁止注册 server 自己为 client，不管 server 是否禁止，阈值（threshold）是 1。client 个数为 n，阈值为 1+2xn（此为一个 server 且禁止自注册的情况）<br>如果是多个 server，且开启了自注册，那么就和 client 一样，是对于其他的 server 来说就是 client，是要x2 的</p><p>Eurake 有一个配置参数 eureka.server.renewalPercentThreshold，定义了 renews 和 renews threshold 的比值，默认值为 0.85。当 server 在 15 分钟内，比值低于 percent，即少了 15%的微服务心跳，server 会进入自我保护状态，Self-Preservation。在此状态下，server 不会删除注册信息，这就有可能导致在调用微服务时，实际上服务并不存在。<br>这种保护状态实际上是考虑了 client 和 server 之间的心跳是因为网络问题，而非服务本身问题，不能简单的删除注册信息</p><p>stackoverflow 上，有人给出的建议是：<br>1、在生产上可以开自注册，部署两个 server<br>2、在本机器上测试的时候，可以把比值调低，比如 0.49<br>3、或者简单粗暴把自我保护模式关闭</p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">eureka.server.enableSelfPreservation=false</div></pre></td></tr></table></figure><p>参考资料：<br>1、understanding spring cloud eureka server self-preservation and renew threshold(<a href="http://stackoverflow.com/questions/33921557/understanding-spring-cloud-eureka-server-self-preservation-and-renew-threshold" target="_blank" rel="external">http://stackoverflow.com/questions/33921557/understanding-spring-cloud-eureka-server-self-preservation-and-renew-threshold</a>)<br>2、Understanding eureka client server communicationUnderstanding eureka client server communication(<a href="https://github.com/Netflix/eureka/wiki/Understanding-eureka-client-server-communication" target="_blank" rel="external">https://github.com/Netflix/eureka/wiki/Understanding-eureka-client-server-communication</a>)<br>3、Eureka never unregisters a service<br>(<a href="http://stackoverflow.com/questions/32616329/eureka-never-unregisters-a-service" target="_blank" rel="external">http://stackoverflow.com/questions/32616329/eureka-never-unregisters-a-service</a>)</p><p>4、<a href="http://blog.csdn.net/zzp448561636/article/details/70198878" target="_blank" rel="external">http://blog.csdn.net/zzp448561636/article/details/70198878</a></p></div><div class="post-tags"><ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring/">Spring</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring-Cloud/">Spring Cloud</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/微服务/">微服务</a></li></ul></div></article><div class="post-nav"><div class="post-nav-item post-nav-next"><a href="/2017/11/06/2017/css-margin-padding-percentages-relative-width/" rel="next" title="前端规范实践"><span>〈 </span>前端规范实践</a></div><div class="post-nav-item post-nav-prev"><a href="/2017/12/15/2017/mongodb-upgrade-to-3-6-0/" rel="prev" title="MongoDB从3.2升级到3.6的二三事">MongoDB从3.2升级到3.6的二三事 <span>〉</span></a></div></div><div id="toc" class="toc-article"><strong class="toc-title">目录</strong><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#服务中心"><span class="toc-text">服务中心</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#常见问题"><span class="toc-text">常见问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-保护模式"><span class="toc-text">1.保护模式</span></a></li></ol></li></ol></div></div></div><footer class="footer text-center"><div id="bottom-inner"><a href="http://hexo.io" target="_blank" class="footer-link">Hexo</a> <a href="https://github.com/microacup/hexo-theme-micorb" target="_blank" class="footer-link">Theme microb</a></div></footer><script>var titleTime,originTitle=document.title;document.addEventListener("visibilitychange",function(){document.hidden?(document.title="[闷声发大财中...] "+originTitle,clearTimeout(titleTime)):(document.title="[+1s] "+originTitle,titleTime=setTimeout(function(){document.title=originTitle},2e3))})</script><script>!function(e,n){function t(){cancelAnimationFrame(o),o=requestAnimationFrame(function e(){var t=n.body.scrollTop||n.documentElement.scrollTop;t>0?(n.body.scrollTop=n.documentElement.scrollTop=t-50,o=requestAnimationFrame(e)):cancelAnimationFrame(o)})}e.requestAnimationFrame=e.requestAnimationFrame||e.webkitRequestAnimationFrame||e.mozRequestAnimationFrame||e.oRequestAnimationFrame||e.msRequestAnimationFrame||function(e){setTimeout(e,1e3/60)},function(){var e=n.getElementById("menu-main-post");if(e){var o=n.getElementById("toc");e.title=o?"目录":"回到顶部",e.onclick=function(){o?"block"==o.style.display?o.style.display="none":o.style.display="block":t()}}}();var o=null}(window,document)</script><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?b6d76ecb62c0651d8e5b7f7085f443f1";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script>!function(e,a,t,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=a.createElement(t),s=a.getElementsByTagName(t)[0],o.async=1,o.src="//www.google-analytics.com/analytics.js",s.parentNode.insertBefore(o,s)}(window,document,"script",0,"ga"),ga("create","UA-78267963-1","auto"),ga("send","pageview")</script></body></html>