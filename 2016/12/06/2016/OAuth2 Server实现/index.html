<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="theme-color" content="#202020"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="keywords" content="Spring,OAuth2,oltu,"><meta name="description" content="基于oltu的oauth2 server"><link rel="icon" type="image/x-icon" href="/logo.png"><title>基于oltu的oauth2 server [ 大新闻 ]</title><link rel="stylesheet" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" href="/css/microb.css"></head><body><nav class="home-menu pure-menu pure-menu-horizontal pure-menu-fixed"><ul class="pure-menu-list float-r clearfix"><li class="pure-menu-item toc-menu"><a id="menu-main-post" class="pure-menu-link" href="javascript:;"><img class="menu-icon" src="/logo.png" alt="MENU"></a></li></ul><a class="pure-menu-heading" href="/"><h1 class="title">大新闻</h1></a></nav><div class="container" id="content-outer"><div class="inner" id="content-inner"><article class="post" id="post"><header class="post-header text-center"><h1 class="title">基于oltu的oauth2 server</h1><time class="time" datetime="2016-12-06T03:03:23.000Z">2016-12-06</time><hr></header><div class="post-content"><h2 id="名词解释"><a href="#名词解释" class="headerlink" title="名词解释"></a>名词解释</h2><ul><li>OAuth2 略</li><li>oltu 参加官方介绍<a href="http://oltu.apache.org/" target="_blank" rel="noopener">http://oltu.apache.org/</a><h2 id="背景介绍"><a href="#背景介绍" class="headerlink" title="背景介绍"></a>背景介绍</h2></li></ul><p>主框架使用<code>Spring + Spring Security</code> 搭建。因为遗留的项目采用了低版本的<code>Spring 3.0.x</code>,所以放弃了<code>Spring</code>提供的<code>spring-security-oauth2</code>。<code>spring-security-oauth2</code>官网提供的例子也像一坨屎，无法让人信服。</p><p>由于Client端的实现较为简单且多样，所以本文主要介绍Authorization Server的实现方式。以authorization_code模式为例</p><h2 id="代码示例"><a href="#代码示例" class="headerlink" title="代码示例"></a>代码示例</h2><ul><li>authorize</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(value = <span class="string">"/authorize"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">authorize</span><span class="params">(HttpServletRequest request, Model model)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//构建OAuth请求</span></span><br><span class="line">        OAuthAuthzRequest oauthRequest = <span class="keyword">new</span> OAuthAuthzRequest(request);</span><br><span class="line">        String responseType = oauthRequest.getParam(OAuth.OAUTH_RESPONSE_TYPE);</span><br><span class="line">        <span class="keyword">if</span> (!ResponseType.CODE.toString().equals(responseType)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> OAuthProblemException.error(<span class="string">"response_type不正确"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String clientId = oauthRequest.getClientId();</span><br><span class="line">        <span class="comment">// 验证clientId是否正确</span></span><br><span class="line">        <span class="keyword">if</span> (!validateOAuth2ClientId(clientId)) &#123;</span><br><span class="line">         	<span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String redirectURI = oauthRequest.getRedirectURI();</span><br><span class="line">        <span class="comment">// 验证redirectURI</span></span><br><span class="line">        <span class="keyword">if</span> (!validateRedirectUri(redirectURI)) &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 查询app信息</span></span><br><span class="line">        String appName = getAppInfo();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 用户是否登录</span></span><br><span class="line">        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();</span><br><span class="line">   		String code = <span class="keyword">new</span> OAuthIssuerImpl(<span class="keyword">new</span> MD5Generator()).authorizationCode();</span><br><span class="line">      	OAuthResponse oauthResponse = OAuthASResponse</span><br><span class="line">                    .authorizationResponse(request, HttpServletResponse.SC_FOUND)</span><br><span class="line">                    .setCode(code)</span><br><span class="line">                    .location(redirectURI)</span><br><span class="line">                    .buildQueryMessage();</span><br><span class="line">      	<span class="keyword">return</span> <span class="string">"redirect:"</span> + oauthResponse.getLocationUri();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (OAuthProblemException ex) &#123;</span><br><span class="line">        ex.printStackTrace();</span><br><span class="line">        model.addAttribute(<span class="string">"message"</span>, ex.getDescription());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (OAuthSystemException e) &#123;</span><br><span class="line">        model.addAttribute(<span class="string">"message"</span>, e.getMessage());</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"site/500"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>access_token</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> ResponseEntity&lt;?&gt; accessToken(HttpServletRequest request) &#123;</span><br><span class="line">    <span class="comment">//构建oauth2请求</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        OAuthTokenRequest oauthRequest = <span class="keyword">new</span> OAuthTokenRequest(request);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// TODO 校验appInfo</span></span><br><span class="line">        String clientId = oauthRequest.getClientId();</span><br><span class="line">        <span class="keyword">if</span> (!validateOAuth2ClientId(clientId)) &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String clientSecret = oauthRequest.getClientSecret();</span><br><span class="line">        <span class="keyword">if</span> (!validateOauth2ClientSecret(clientSecret)) &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String grantType = oauthRequest.getGrantType();</span><br><span class="line">        <span class="keyword">if</span> (!validateOauth2GrantType(grantType)) &#123;</span><br><span class="line">           <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String code = oauthRequest.getCode();</span><br><span class="line">        String openId = oAuth2Service.getOpenId(code);</span><br><span class="line">        <span class="keyword">if</span> (openId == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 生成AccessToken</span></span><br><span class="line">        OAuthIssuerImpl oAuthIssuer = <span class="keyword">new</span> OAuthIssuerImpl(<span class="keyword">new</span> MD5Generator());</span><br><span class="line">        String accessToken = oAuthIssuer.accessToken();</span><br><span class="line">        oAuth2Service.addAccessToken(accessToken, openId);</span><br><span class="line">        oAuth2Service.evict(code);</span><br><span class="line">         <span class="comment">//生成OAuth响应</span></span><br><span class="line">         OAuthResponse response = OAuthASResponse</span><br><span class="line">                 .tokenResponse(HttpServletResponse.SC_OK)</span><br><span class="line">                 .setAccessToken(accessToken)</span><br><span class="line">                 .setParam(<span class="string">"openId"</span>, openId)</span><br><span class="line">                 .setExpiresIn(String.valueOf(oAuth2Service.getExpireIn()))</span><br><span class="line">                 .buildJSONMessage();</span><br><span class="line">         <span class="keyword">return</span> ResponseEntity.ok(response.getBody());</span><br><span class="line">     &#125;  <span class="keyword">catch</span> (OAuthProblemException e) &#123;</span><br><span class="line">         e.printStackTrace();</span><br><span class="line">         <span class="keyword">return</span> ResponseEntity.badRequest().body(e.getDescription());</span><br><span class="line">     &#125; <span class="keyword">catch</span> (OAuthSystemException e) &#123;</span><br><span class="line">         e.printStackTrace();</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">return</span> ResponseEntity.badRequest().body(<span class="string">"未知错误"</span>);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>完整示例请参考开源项目：<a href="https://github.com/microacup/microbbs" target="_blank" rel="noopener">microbbs</a></p><h2 id="参考资料："><a href="#参考资料：" class="headerlink" title="参考资料："></a>参考资料：</h2><ul><li><a href="http://oltu.apache.org/" target="_blank" rel="noopener">http://oltu.apache.org/</a></li></ul></div><div class="post-tags"><ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/OAuth2/">OAuth2</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring/">Spring</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/oltu/">oltu</a></li></ul></div></article><div class="post-nav"><div class="post-nav-item post-nav-next"><a href="/2016/11/21/2016/Spring-Thymeleaf-User-Details/" rel="next" title="Spring Thymeleaf User Details"><span>〈 </span>Spring Thymeleaf User Details</a></div><div class="post-nav-item post-nav-prev"><a href="/2016/12/08/2016/mysql-utf8mb4-emoji/" rel="prev" title="MySQL修改字符集编码为utf8mb4支持emoji存储">MySQL修改字符集编码为utf8mb4支持emoji存储 <span>〉</span></a></div></div><div id="toc" class="toc-article"><strong class="toc-title">目录</strong><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#名词解释"><span class="toc-text">名词解释</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#背景介绍"><span class="toc-text">背景介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#代码示例"><span class="toc-text">代码示例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考资料："><span class="toc-text">参考资料：</span></a></li></ol></div></div></div><footer class="footer text-center"><div id="bottom-inner"><a href="http://hexo.io" target="_blank" class="footer-link">Hexo</a> <a href="https://github.com/microacup/hexo-theme-micorb" target="_blank" class="footer-link">Theme microb</a></div></footer><script>var titleTime,originTitle=document.title;document.addEventListener("visibilitychange",function(){document.hidden?(document.title="[闷声发大财中...] "+originTitle,clearTimeout(titleTime)):(document.title="[+1s] "+originTitle,titleTime=setTimeout(function(){document.title=originTitle},2e3))})</script><script>!function(e,t){e.requestAnimationFrame=e.requestAnimationFrame||e.webkitRequestAnimationFrame||e.mozRequestAnimationFrame||e.oRequestAnimationFrame||e.msRequestAnimationFrame||function(e){setTimeout(e,1e3/60)},function(){var e=t.getElementById("menu-main-post");if(e){var n=t.getElementById("toc");e.title=n?"目录":"回到顶部",e.onclick=function(){n?"block"==n.style.display?n.style.display="none":n.style.display="block":(cancelAnimationFrame(o),o=requestAnimationFrame(function e(){var n=t.body.scrollTop||t.documentElement.scrollTop;0<n?(t.body.scrollTop=t.documentElement.scrollTop=n-50,o=requestAnimationFrame(e)):cancelAnimationFrame(o)}))}}}();var o=null}(window,document)</script><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?b6d76ecb62c0651d8e5b7f7085f443f1";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script>!function(e,a,t,n,g,c,o){e.GoogleAnalyticsObject="ga",e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=1*new Date,c=a.createElement(t),o=a.getElementsByTagName(t)[0],c.async=1,c.src="//www.google-analytics.com/analytics.js",o.parentNode.insertBefore(c,o)}(window,document,"script"),ga("create","UA-78267963-1","auto"),ga("send","pageview")</script></body></html>