<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="theme-color" content="#202020"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="keywords" content="Docker,Node.js,MongoDB,Redis,Nginx,"><meta name="description" content="docker部署nodejs+mongodb+redis+nginx"><link rel="icon" type="image/x-icon" href="/logo.png"><title>docker部署nodejs+mongodb+redis+nginx [ 大新闻 ]</title><link rel="stylesheet" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" href="/css/microb.css"></head><body><nav class="home-menu pure-menu pure-menu-horizontal pure-menu-fixed"><ul class="pure-menu-list float-r clearfix"><li class="pure-menu-item toc-menu"><a id="menu-main-post" class="pure-menu-link" href="javascript:;"><img class="menu-icon" src="/logo.png" alt="MENU"></a></li></ul><a class="pure-menu-heading" href="/"><h1 class="title">大新闻</h1></a></nav><div class="container" id="content-outer"><div class="inner" id="content-inner"><article class="post" id="post"><header class="post-header text-center"><h1 class="title">docker部署nodejs+mongodb+redis+nginx</h1><time class="time" datetime="2017-08-31T12:50:22.000Z">2017-08-31</time><hr></header><div class="post-content"><blockquote><p>使用Docker-Compose部署Nodejs应用，Nginx反向代理实现负载均衡。</p></blockquote><a id="more"></a><h2 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h2><p><img src="Docker整体架构.png" alt=""></p><h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><ul><li>docker-conmpose.yml</li></ul><figure class="highlight yaml"><table><tr><td class="code"><pre><div class="line"><span class="attr">version:</span> <span class="string">'3'</span></div><div class="line"><span class="attr">services:</span></div><div class="line"><span class="attr">  live-nginx:</span></div><div class="line"><span class="attr">    image:</span> <span class="string">nginx</span></div><div class="line"><span class="attr">    restart:</span> <span class="string">on-failure</span></div><div class="line"><span class="attr">    networks:</span></div><div class="line"><span class="bullet">      -</span> <span class="string">backend</span></div><div class="line"><span class="attr">    ports:</span> </div><div class="line"><span class="bullet">     -</span> <span class="string">"7000:7000"</span></div><div class="line"><span class="attr">    volumes:</span></div><div class="line"><span class="bullet">     -</span> <span class="string">/opt/live/live-server/nginx.conf:/etc/nginx/nginx.conf</span></div><div class="line"><span class="attr">    depends_on:</span></div><div class="line"><span class="bullet">      -</span> <span class="string">live-server</span></div><div class="line"><span class="attr">  live-server:</span></div><div class="line"><span class="attr">    image:</span> <span class="string">"node:8.4.0"</span></div><div class="line"><span class="attr">    restart:</span> <span class="string">on-failure</span></div><div class="line"><span class="attr">    expose:</span> </div><div class="line"><span class="bullet">     -</span> <span class="string">"7000"</span></div><div class="line">     <span class="comment"># 挂在本地目录到/opt/live/server</span></div><div class="line"><span class="attr">    volumes:</span></div><div class="line"><span class="bullet">     -</span> <span class="string">/opt/live/live-server:/opt/live/server</span></div><div class="line">     <span class="comment"># 运行命令</span></div><div class="line"><span class="attr">    command:</span> <span class="string">["npm",</span> <span class="string">"run"</span><span class="string">,</span> <span class="string">"docker"</span><span class="string">]</span></div><div class="line">     <span class="comment"># 工作目录</span></div><div class="line"><span class="attr">    working_dir:</span> <span class="string">"/opt/live/server"</span></div><div class="line"><span class="attr">    networks:</span></div><div class="line"><span class="attr">      backend:</span></div><div class="line"><span class="attr">        aliases:</span></div><div class="line"><span class="bullet">          -</span> <span class="string">apps</span></div><div class="line"><span class="attr">    depends_on:</span></div><div class="line"><span class="bullet">      -</span> <span class="string">live-redis</span></div><div class="line"><span class="bullet">      -</span> <span class="string">live-mongo</span></div><div class="line"><span class="attr">  live-redis:</span></div><div class="line"><span class="attr">    image:</span> <span class="string">"redis"</span></div><div class="line"><span class="attr">    networks:</span></div><div class="line"><span class="bullet">      -</span> <span class="string">backend</span></div><div class="line"><span class="attr">  live-mongo:</span></div><div class="line"><span class="attr">    networks:</span></div><div class="line"><span class="bullet">      -</span> <span class="string">backend</span></div><div class="line"><span class="attr">    image:</span> <span class="string">"mongo"</span></div><div class="line"><span class="attr">    expose:</span></div><div class="line"><span class="bullet">     -</span> <span class="string">"27017"</span></div><div class="line"><span class="attr">    volumes:</span></div><div class="line"><span class="attr">     - mongodata:</span><span class="string">/data/db</span></div><div class="line"><span class="attr">volumes:</span></div><div class="line"><span class="attr">    mongodata:</span></div><div class="line"><span class="attr">networks:</span></div><div class="line"><span class="attr">  backend:</span></div><div class="line"><span class="attr">    driver:</span> <span class="string">overlay</span></div></pre></td></tr></table></figure><ul><li><p>nginx.conf</p><figure class="highlight nginx"><table><tr><td class="code"><pre><div class="line"><span class="comment">#...ok</span></div></pre></td></tr></table></figure><p>​</p></li></ul><h2 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h2><figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="comment"># 上线</span></div><div class="line">docker-compose up -d --scale live-server=<span class="number">2</span></div><div class="line"></div><div class="line"><span class="comment"># 列出</span></div><div class="line">docker-compose ps</div><div class="line"></div><div class="line"><span class="comment"># 停止</span></div><div class="line">docker-compose stop [service]</div><div class="line"></div><div class="line"><span class="comment"># 下线</span></div><div class="line">docker-compose down [service]</div></pre></td></tr></table></figure><h2 id="简单说明："><a href="#简单说明：" class="headerlink" title="简单说明："></a>简单说明：</h2><ol><li>所有service必须在同一个networks下，这样可通过service名称互相访问。</li><li>live-server可以部署多个，通过scale参数指定</li><li>使用depends_on解决依赖</li><li>数据不要放在docker中，使用volumes挂载宿主机文件夹</li><li>使用restart指定重启策略，注意不要always，可能导致真的异常</li></ol></div><div class="post-tags"><ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Docker/">Docker</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MongoDB/">MongoDB</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Nginx/">Nginx</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Node-js/">Node.js</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Redis/">Redis</a></li></ul></div></article><div class="post-nav"><div class="post-nav-item post-nav-next"><a href="/2017/08/25/2017/chrome-localhost-6000-err-unsafe-port/" rel="next" title="关于Chrome访问6000等端口报ERR_UNSAFE_PORT的问题"><span>〈 </span>关于Chrome访问6000等端口报ERR_UNSAFE_PORT的问题</a></div><div class="post-nav-item post-nav-prev"><a href="/2017/09/08/2017/spring-dynamic-create-remoting-invoker/" rel="prev" title="Spring远程调用-HttpInvokerProxyFactoryBean和HttpInvokerServiceExporter">Spring远程调用-HttpInvokerProxyFactoryBean和HttpInvokerServiceExporter <span>〉</span></a></div></div><div id="toc" class="toc-article"><strong class="toc-title">目录</strong><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#架构"><span class="toc-text">架构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#配置文件"><span class="toc-text">配置文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#运行"><span class="toc-text">运行</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#简单说明："><span class="toc-text">简单说明：</span></a></li></ol></div></div></div><footer class="footer text-center"><div id="bottom-inner"><a href="http://hexo.io" target="_blank" class="footer-link">Hexo</a> <a href="https://github.com/microacup/hexo-theme-micorb" target="_blank" class="footer-link">Theme microb</a></div></footer><script>var titleTime,originTitle=document.title;document.addEventListener("visibilitychange",function(){document.hidden?(document.title="[闷声发大财中...] "+originTitle,clearTimeout(titleTime)):(document.title="[+1s] "+originTitle,titleTime=setTimeout(function(){document.title=originTitle},2e3))})</script><script>!function(n,e){!function(){var n=e.getElementById("menu-main-post");if(n){var t=e.getElementById("toc");t?n.onclick=function(){t&&("block"==t.style.display?t.style.display="none":t.style.display="block")}:n.style.display="none"}}()}(window,document)</script><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?b6d76ecb62c0651d8e5b7f7085f443f1";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script>!function(e,a,t,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=a.createElement(t),s=a.getElementsByTagName(t)[0],o.async=1,o.src="//www.google-analytics.com/analytics.js",s.parentNode.insertBefore(o,s)}(window,document,"script",0,"ga"),ga("create","UA-78267963-1","auto"),ga("send","pageview")</script></body></html>