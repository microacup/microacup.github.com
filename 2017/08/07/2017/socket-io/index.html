<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="theme-color" content="#202020"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="keywords" content="坑,Node.js,WebSocket,"><meta name="description" content="socket.io常见问题"><link rel="icon" type="image/x-icon" href="/logo.png"><title>socket.io常见问题 [ 大新闻 ]</title><link rel="stylesheet" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" href="/css/microb.css"></head><body><nav class="home-menu pure-menu pure-menu-horizontal pure-menu-fixed"><ul class="pure-menu-list float-r clearfix"><li class="pure-menu-item toc-menu"><a id="menu-main-post" class="pure-menu-link" href="javascript:;"><img class="menu-icon" src="/logo.png" alt="MENU"></a></li></ul><a class="pure-menu-heading" href="/"><h1 class="title">大新闻</h1></a></nav><div class="container" id="content-outer"><div class="inner" id="content-inner"><article class="post" id="post"><header class="post-header text-center"><h1 class="title">socket.io常见问题</h1><time class="time" datetime="2017-08-07T05:16:01.000Z">2017-08-07</time><hr></header><div class="post-content"><blockquote><p>记录使用Socket.io过程中遇到的各种问题及解决方案。</p></blockquote><a id="more"></a><h5 id="1-PM2服务器启动后，一直400，因为负载均衡导致。"><a href="#1-PM2服务器启动后，一直400，因为负载均衡导致。" class="headerlink" title="1. PM2服务器启动后，一直400，因为负载均衡导致。"></a>1. PM2服务器启动后，一直400，因为负载均衡导致。</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">failed: Error during WebSocket handshake: Unexpected response code: 400</span><br></pre></td></tr></table></figure><p>可以参考官方配置。</p><p><strong>解决方案</strong>：</p><p>配合Nginx IpHash + Pm2启动多个端口app：</p><p>参考这个 ：</p><p><a href="https://github.com/socketio/socket.io/issues/1942" target="_blank" rel="noopener">https://github.com/socketio/socket.io/issues/1942</a></p><p><a href="https://github.com/Unitech/pm2/issues/637" target="_blank" rel="noopener">https://github.com/Unitech/pm2/issues/637</a></p><p><a href="http://www.cnblogs.com/accordion/p/6930152.html" target="_blank" rel="noopener">http://www.cnblogs.com/accordion/p/6930152.html</a></p><ul><li><p>pm2配置文件，app.json：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"apps"</span>: [&#123;</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"hxdd-7101"</span>,</span><br><span class="line">    <span class="attr">"port"</span>: <span class="number">7101</span>,</span><br><span class="line">    <span class="attr">"script"</span>: <span class="string">"bin/www"</span>,</span><br><span class="line">    <span class="attr">"env"</span>: &#123;</span><br><span class="line">      <span class="attr">"NODE_ENV"</span>: <span class="string">"production"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"args"</span>: <span class="string">"['-p7101','-t','plan']"</span>,</span><br><span class="line">    <span class="attr">"exec_mode"</span>: <span class="string">"cluster"</span>,</span><br><span class="line">    <span class="attr">"autorestart"</span>: <span class="literal">true</span></span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"hxdd-7102"</span>,</span><br><span class="line">    <span class="attr">"port"</span>: <span class="number">7102</span>,</span><br><span class="line">    <span class="attr">"script"</span>: <span class="string">"bin/www"</span>,</span><br><span class="line">    <span class="attr">"env"</span>: &#123;</span><br><span class="line">      <span class="attr">"NODE_ENV"</span>: <span class="string">"production"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"args"</span>: <span class="string">"['-p7102','-t','plan']"</span>,</span><br><span class="line">    <span class="attr">"exec_mode"</span>: <span class="string">"cluster"</span>,</span><br><span class="line">    <span class="attr">"autorestart"</span>: <span class="literal">true</span></span><br><span class="line">  &#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>Nginx配置：</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">upstream</span> io_nodes &#123;</span><br><span class="line">   ip_hash; # 这里，可以可以根据cookie等设置，总之是让它访问同一台服务器</span><br><span class="line">   <span class="attribute">server</span> <span class="number">127.0.0.1:7101</span>;</span><br><span class="line">   <span class="attribute">server</span> <span class="number">127.0.0.1:7102</span>;</span><br><span class="line">&#125;</span><br><span class="line">      </span><br><span class="line"><span class="attribute">location</span><span class="regexp"> ^~</span> /socket.io/ &#123;</span><br><span class="line">   <span class="attribute">proxy_pass</span>  http://io_nodes;</span><br><span class="line">   <span class="attribute">proxy_redirect</span> <span class="literal">off</span>;</span><br><span class="line">   <span class="attribute">proxy_http_version</span> <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line">   <span class="attribute">proxy_set_header</span> Upgrade <span class="variable">$http_upgrade</span>;</span><br><span class="line">   <span class="attribute">proxy_set_header</span> Connection <span class="string">"upgrade"</span>;</span><br><span class="line">   <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>:<span class="variable">$server_port</span>;</span><br><span class="line">   <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">   <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>​</p></li></ul><h5 id="2-总有些数据库连接垃圾数据无法disconnect时删除"><a href="#2-总有些数据库连接垃圾数据无法disconnect时删除" class="headerlink" title="2. 总有些数据库连接垃圾数据无法disconnect时删除"></a>2. 总有些数据库连接垃圾数据无法disconnect时删除</h5><p>如果因为服务器网络或者重启等导致无法监听到disconnect或某些属性丢失，在线的连接无法删除。</p><p><strong>解决方案：</strong></p><p>设置connection的ttl属性。过期自动删除。客户端加入探测机制，ttl时间内在线的，刷新ttl时间，延长租期。</p></div><div class="post-tags"><ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Node-js/">Node.js</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/WebSocket/">WebSocket</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/坑/">坑</a></li></ul></div></article><div class="post-nav"><div class="post-nav-item post-nav-next"><a href="/2017/08/02/2017/Spring-message-中文乱码/" rel="next" title="解决使用Idea启动Tomcat, Spring Message中文乱码"><span>〈 </span>解决使用Idea启动Tomcat, Spring Message中文乱码</a></div><div class="post-nav-item post-nav-prev"><a href="/2017/08/11/2017/use-dllplugin-webpack/" rel="prev" title="Webpack使用DllPlugin加速打包，并自动插入html">Webpack使用DllPlugin加速打包，并自动插入html <span>〉</span></a></div></div><div id="toc" class="toc-article"><strong class="toc-title">目录</strong><ol class="toc"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-PM2服务器启动后，一直400，因为负载均衡导致。"><span class="toc-text">1. PM2服务器启动后，一直400，因为负载均衡导致。</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-总有些数据库连接垃圾数据无法disconnect时删除"><span class="toc-text">2. 总有些数据库连接垃圾数据无法disconnect时删除</span></a></li></ol></div></div></div><footer class="footer text-center"><div id="bottom-inner"><a href="http://hexo.io" target="_blank" class="footer-link">Hexo</a> <a href="https://github.com/microacup/hexo-theme-micorb" target="_blank" class="footer-link">Theme microb</a></div></footer><script>var titleTime,originTitle=document.title;document.addEventListener("visibilitychange",function(){document.hidden?(document.title="[闷声发大财中...] "+originTitle,clearTimeout(titleTime)):(document.title="[+1s] "+originTitle,titleTime=setTimeout(function(){document.title=originTitle},2e3))})</script><script>!function(e,t){e.requestAnimationFrame=e.requestAnimationFrame||e.webkitRequestAnimationFrame||e.mozRequestAnimationFrame||e.oRequestAnimationFrame||e.msRequestAnimationFrame||function(e){setTimeout(e,1e3/60)},function(){var e=t.getElementById("menu-main-post");if(e){var n=t.getElementById("toc");e.title=n?"目录":"回到顶部",e.onclick=function(){n?"block"==n.style.display?n.style.display="none":n.style.display="block":(cancelAnimationFrame(o),o=requestAnimationFrame(function e(){var n=t.body.scrollTop||t.documentElement.scrollTop;0<n?(t.body.scrollTop=t.documentElement.scrollTop=n-50,o=requestAnimationFrame(e)):cancelAnimationFrame(o)}))}}}();var o=null}(window,document)</script><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?b6d76ecb62c0651d8e5b7f7085f443f1";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script>!function(e,a,t,n,g,c,o){e.GoogleAnalyticsObject="ga",e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=1*new Date,c=a.createElement(t),o=a.getElementsByTagName(t)[0],c.async=1,c.src="//www.google-analytics.com/analytics.js",o.parentNode.insertBefore(c,o)}(window,document,"script"),ga("create","UA-78267963-1","auto"),ga("send","pageview")</script></body></html>