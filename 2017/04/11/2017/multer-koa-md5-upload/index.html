<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="theme-color" content="#202020"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="keywords" content="Node.js,Koa,"><meta name="description" content="koa使用multer上传实现以文件hash(md5)作为文件名附文件秒传原理"><link rel="icon" type="image/x-icon" href="/logo.png"><title>koa使用multer上传实现以文件hash(md5)作为文件名附文件秒传原理 [ 大新闻 ]</title><link rel="stylesheet" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" href="/css/microb.css"></head><body><nav class="home-menu pure-menu pure-menu-horizontal pure-menu-fixed"><ul class="pure-menu-list float-r clearfix"><li class="pure-menu-item toc-menu"><a id="menu-main-post" class="pure-menu-link" href="javascript:;"><img class="menu-icon" src="/logo.png" alt="MENU"></a></li></ul><a class="pure-menu-heading" href="/"><h1 class="title">大新闻</h1></a></nav><div class="container" id="content-outer"><div class="inner" id="content-inner"><article class="post" id="post"><header class="post-header text-center"><h1 class="title">koa使用multer上传实现以文件hash(md5)作为文件名附文件秒传原理</h1><time class="time" datetime="2017-04-11T08:08:59.000Z">2017-04-11</time><hr></header><div class="post-content"><p>multer是express模块下的文件上传中间件，类似的中间件还有formidable等，这里以multer为例说明如何实现以文件的hash（如md5）命名。以及文件秒传原理。</p><a id="more"></a><h2 id="文件秒传原理"><a href="#文件秒传原理" class="headerlink" title="文件秒传原理"></a>文件秒传原理</h2><p>在文件上传时，客户端会同步对待上传的文件进行hash计算，以MD5为例，配合客户端极速上传插件，可以很快完成。用计算出的hashCode去服务端查找，如果存在该记录的文件，则无需继续上传，直接标记完成，达到秒传的效果。</p><p>服务端需要做的就是记录存储的文件与hashCode的关系，提供API查询。</p><blockquote><p>文件秒传中存在的问题依然是hash碰撞，按照MD5的存储信息量，在现实中，除非故意如此，其实可以忽略不计。</p><p>这就是为什么， 你好不容易下了片，上传到网盘几秒就成功了。</p></blockquote><h2 id="大文件的MD5计算"><a href="#大文件的MD5计算" class="headerlink" title="大文件的MD5计算"></a>大文件的MD5计算</h2><p>文件秒传存在的意义在于，对于大文件，一方面可以减少服务器存储压力，节省流量，另一方面，可以减少传输时间。</p><p>很多东西，只要一大，就有些问题了。大文件的hash计算也是如此，如果全部读入内存，内存就爆了。好在hash计算本就是分片的（MD5以512位分组来处理输入的信息），那么可以使用流的方式，分片计算，最后算出整个文件的md5。我们可以把这个过程放到第一次文件上传时进行：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line"><span class="keyword">var</span> crypto = <span class="built_in">require</span>(<span class="string">'crypto'</span>)</div><div class="line"><span class="comment">// 分片计算</span></div><div class="line">file.stream.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">chunk</span>) </span>&#123;</div><div class="line">	hash.update(chunk)</div><div class="line">&#125;)</div><div class="line">file.stream.on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  	<span class="keyword">var</span> md5 = hash.digest(<span class="string">'hex'</span>);</div><div class="line">  	<span class="comment">// 计算完成</span></div><div class="line">&#125;)</div></pre></td></tr></table></figure><h2 id="koa-multer-实现md5作为文件名"><a href="#koa-multer-实现md5作为文件名" class="headerlink" title="koa-multer 实现md5作为文件名"></a>koa-multer 实现md5作为文件名</h2><p>请见<a href="https://github.com/microacup/multer/blob/master/storage/disk.js" target="_blank" rel="external">multer</a> 把修改后的disk.js放到自己的目录。使用示例见下：</p><p>multerUtil.js</p><figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">"fs"</span>);</div><div class="line"><span class="keyword">const</span> multer = <span class="built_in">require</span>(<span class="string">'koa-multer'</span>);</div><div class="line"><span class="keyword">const</span> diskStorage = <span class="built_in">require</span>(<span class="string">'./disk'</span>);</div><div class="line">multer.diskStorage = diskStorage;</div><div class="line"></div><div class="line"><span class="comment">// 自动创建支持的存储路径</span></div><div class="line"><span class="keyword">const</span> floders = [<span class="string">'avatar'</span>, <span class="string">'record'</span>, <span class="string">'channel'</span>];</div><div class="line"><span class="keyword">for</span> (<span class="keyword">const</span> floder <span class="keyword">of</span> floders) &#123;</div><div class="line">  <span class="keyword">const</span> path = <span class="string">`uploads/images/<span class="subst">$&#123;floder&#125;</span>`</span>;</div><div class="line">  <span class="keyword">if</span> (!fs.existsSync(path))&#123;</div><div class="line">    fs.mkdirSync(path);</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">const</span> storage = multer.diskStorage(&#123;</div><div class="line">  destination: <span class="function"><span class="keyword">function</span> (<span class="params">req, file, cb</span>) </span>&#123;</div><div class="line">    <span class="keyword">const</span> floder = req.body.floder; <span class="comment">// 目标文件夹名称</span></div><div class="line">    <span class="keyword">if</span> (<span class="regexp">/^[a-zA-Z\d]+$/</span>.test(floder)) &#123;</div><div class="line">      cb(<span class="literal">null</span>, <span class="string">`uploads/images/<span class="subst">$&#123;floder&#125;</span>`</span>);</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line"> &#125;);</div><div class="line"></div><div class="line"><span class="keyword">const</span> upload = multer(&#123;</div><div class="line">  storage: storage,</div><div class="line">  limits: &#123;</div><div class="line">    fileSize: <span class="number">1024</span> * <span class="number">1024</span>, <span class="comment">// bytes</span></div><div class="line">  &#125;</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = upload;</div></pre></td></tr></table></figure><p>index.js</p><figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line"><span class="keyword">const</span> router = <span class="built_in">require</span>(<span class="string">'koa-router'</span>)();</div><div class="line"><span class="keyword">const</span> service = <span class="built_in">require</span>(<span class="string">'./service'</span>);</div><div class="line"><span class="keyword">const</span> authService = <span class="built_in">require</span>(<span class="string">'../../auth/service'</span>);</div><div class="line"><span class="keyword">const</span> upload = <span class="built_in">require</span>(<span class="string">'./multerUtil'</span>);</div><div class="line"></div><div class="line">router.post(<span class="string">'/'</span>, upload.single(<span class="string">'file'</span>), service.upload);</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = router;</div></pre></td></tr></table></figure><p>service.js</p><figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line"><span class="keyword">const</span> HttpStatus = <span class="built_in">require</span>(<span class="string">'http-status-codes'</span>);</div><div class="line"></div><div class="line"><span class="keyword">import</span> &#123; Result &#125; <span class="keyword">from</span> <span class="string">'../Result'</span>;</div><div class="line"><span class="keyword">const</span> User = <span class="built_in">require</span>(<span class="string">'../../database'</span>).models.user;</div><div class="line"></div><div class="line"><span class="keyword">const</span> service = &#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * 通用的上传，上传完成返回文件路径</span></div><div class="line"><span class="comment">   * </span></div><div class="line"><span class="comment">   * @param &#123;*&#125; ctx </span></div><div class="line"><span class="comment">   * @param &#123;*&#125; next </span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <span class="keyword">async</span> upload(ctx, next) &#123;</div><div class="line">    <span class="keyword">const</span> floder = ctx.req.body.floder; <span class="comment">// 目标文件夹</span></div><div class="line">    <span class="keyword">const</span> file = ctx.req.file;</div><div class="line">    <span class="keyword">const</span> path = <span class="string">`/images/<span class="subst">$&#123;floder&#125;</span>/<span class="subst">$&#123;file.filename&#125;</span>`</span>;</div><div class="line">    <span class="keyword">return</span> ctx.body = Result.ok(path);</div><div class="line">  &#125;,</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = service;</div></pre></td></tr></table></figure><h2 id="关于Hash"><a href="#关于Hash" class="headerlink" title="关于Hash"></a>关于Hash</h2><p>其实hash，本身就是个摘要，只要能概况这个文件或事物本身，那他也算个hash.比如你的名字。</p></div><div class="post-tags"><ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Koa/">Koa</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Node-js/">Node.js</a></li></ul></div></article><div class="post-nav"><div class="post-nav-item post-nav-next"><a href="/2017/03/27/2017/mongoose-aggregate-by-date/" rel="next" title="mongoose使用aggregate实现按照日期分组统计"><span>〈 </span>mongoose使用aggregate实现按照日期分组统计</a></div><div class="post-nav-item post-nav-prev"><a href="/2017/08/02/2017/Spring-message-中文乱码/" rel="prev" title="解决使用Idea启动Tomcat, Spring Message中文乱码">解决使用Idea启动Tomcat, Spring Message中文乱码 <span>〉</span></a></div></div><div id="toc" class="toc-article"><strong class="toc-title">目录</strong><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#文件秒传原理"><span class="toc-text">文件秒传原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#大文件的MD5计算"><span class="toc-text">大文件的MD5计算</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#koa-multer-实现md5作为文件名"><span class="toc-text">koa-multer 实现md5作为文件名</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#关于Hash"><span class="toc-text">关于Hash</span></a></li></ol></div></div></div><footer class="footer text-center"><div id="bottom-inner"><a href="" target="_blank" class="footer-link">Hexo</a> <a href="" target="_blank" class="footer-link">Theme microb</a></div></footer><script>var titleTime,originTitle=document.title;document.addEventListener("visibilitychange",function(){document.hidden?(document.title="[闷声发大财中...] "+originTitle,clearTimeout(titleTime)):(document.title="[+1s] "+originTitle,titleTime=setTimeout(function(){document.title=originTitle},2e3))})</script><script>!function(n,e){!function(){var n=e.getElementById("menu-main-post");if(n){var t=e.getElementById("toc");t?n.onclick=function(){t&&("block"==t.style.display?t.style.display="none":t.style.display="block")}:n.style.display="none"}}()}(window,document)</script><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?b6d76ecb62c0651d8e5b7f7085f443f1";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script>!function(e,a,t,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=a.createElement(t),s=a.getElementsByTagName(t)[0],o.async=1,o.src="//www.google-analytics.com/analytics.js",s.parentNode.insertBefore(o,s)}(window,document,"script",0,"ga"),ga("create","UA-78267963-1","auto"),ga("send","pageview")</script></body></html>