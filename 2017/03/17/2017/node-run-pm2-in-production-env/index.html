<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="theme-color" content="#202020"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="keywords" content="Node.js,pm2,"><meta name="description" content="在生产环境中使用PM2运行Node"><link rel="icon" type="image/x-icon" href="/logo.png"><title>在生产环境中使用PM2运行Node [ 大新闻 ]</title><link rel="stylesheet" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" href="/css/microb.css"></head><body><nav class="home-menu pure-menu pure-menu-horizontal pure-menu-fixed"><ul class="pure-menu-list float-r clearfix"><li class="pure-menu-item toc-menu"><a id="menu-main-post" class="pure-menu-link" href="javascript:;"><img class="menu-icon" src="/logo.png" alt="MENU"></a></li></ul><a class="pure-menu-heading" href="/"><h1 class="title">大新闻</h1></a></nav><div class="container" id="content-outer"><div class="inner" id="content-inner"><article class="post" id="post"><header class="post-header text-center"><h1 class="title">在生产环境中使用PM2运行Node</h1><time class="time" datetime="2017-03-17T02:14:58.000Z">2017-03-17</time><hr></header><div class="post-content"><h2 id="序"><a href="#序" class="headerlink" title="序"></a>序</h2><p>PM2 is a production process manager for Node.js applications with a built-in load balancer. It allows you to keep applications alive forever, to reload them without downtime and to facilitate common system admin tasks.</p><p>Starting an application in production mode is as easy as:</p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ pm2 start app.js</div></pre></td></tr></table></figure><p>PM2 is constantly assailed by <a href="https://travis-ci.org/Unitech/pm2" target="_blank" rel="external">more than 1000 tests</a>.</p><p>Official website: <a href="http://pm2.keymetrics.io/" target="_blank" rel="external">http://pm2.keymetrics.io/</a></p><p>Works on Linux (stable) &amp; MacOSx (stable) &amp; Windows (stable).</p><h2 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h2><p>默认情况下，node环境变量是空的，在线上环境运行，肯定需要把环境变量设为生产环境。一般情况下，在<code>package.json</code>的<code>scripts</code> 中设置 <code>cross-env NODE_ENV=production</code> 就完成任务了，但是在pm2中却不灵了。</p><p>简短的使用pm2部署node生产环境的步骤：</p><h3 id="1-创建配置文件app-json"><a href="#1-创建配置文件app-json" class="headerlink" title="1. 创建配置文件app.json"></a>1. 创建配置文件app.json</h3><p>当前你也可以随便起其他名字，或者是一个数组，更高级的用法参考官网文档。</p><p>app.json:</p><figure class="highlight"><table><tr><td class="code"><pre><div class="line">&#123;</div><div class="line">  ...</div><div class="line">  "script": "bin/run",</div><div class="line">  "env": &#123;</div><div class="line">    "NODE_ENV": "production"</div><div class="line">  &#125;,</div><div class="line">  "instances": 0,</div><div class="line">  "exec_mode": "cluster",</div><div class="line">  "autorestart": true,</div><div class="line">  ...</div><div class="line">&#125;</div></pre></td></tr></table></figure><blockquote><p>说明：</p><ul><li>env 指定node运行环境，默认空</li><li>instances 运行实例个数，设置为0则根据处理器情况，生成最大的实例数</li><li>exec_mode 默认为fork，指定了instances后则为集群模式</li><li>autorestart 默认false，自动启动</li><li>其他参数可以参考pm2文档: <a href="http://pm2.keymetrics.io/" target="_blank" rel="external">http://pm2.keymetrics.io/</a></li></ul></blockquote><h3 id="2-在package-json中创建scripts-item"><a href="#2-在package-json中创建scripts-item" class="headerlink" title="2. 在package.json中创建scripts item"></a>2. 在package.json中创建scripts item</h3><p>package.json:</p><figure class="highlight"><table><tr><td class="code"><pre><div class="line">... </div><div class="line">"scripts": &#123;</div><div class="line">  "pm2": "pm2 start app.json"</div><div class="line">&#125;,</div><div class="line">...</div></pre></td></tr></table></figure><h3 id="3-运行"><a href="#3-运行" class="headerlink" title="3. 运行"></a>3. 运行</h3><p>start it easily:</p><figure class="highlight shell"><table><tr><td class="code"><pre><div class="line"><span class="meta">$</span> npm run pm2</div></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><div class="line">│ App name │ id │ mode    │ pid   │ status  │ restart │ uptime │ cpu │ mem        │ watching │</div><div class="line">├──────────┼────┼─────────┼───────┼─────────┼─────────┼────────┼─────┼────────────┼──────────┤</div><div class="line">│ run      │ 0  │ cluster │ 15480 │ online  │ 23      │ 45s    │ 0%  │ 117.5 MB   │ disabled │</div><div class="line">│ run      │ 1  │ cluster │ 9208  │ online  │ 20      │ 45s    │ 0%  │ 116.1 MB   │ disabled │</div><div class="line">│ run      │ 2  │ cluster │ 13440 │ online  │ 24      │ 45s    │ 0%  │ 121.2 MB   │ disabled │</div><div class="line">│ run      │ 3  │ cluster │ 14228 │ online  │ 23      │ 45s    │ 0%  │ 115.6 MB   │ disabled │</div></pre></td></tr></table></figure><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><p><a href="http://pm2.keymetrics.io/docs/usage/pm2-doc-single-page/" target="_blank" rel="external">PM2官方文档</a></p><p>​</p></li></ul></div><div class="post-tags"><ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Node-js/">Node.js</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pm2/">pm2</a></li></ul></div></article><div class="post-nav"><div class="post-nav-item post-nav-next"><a href="/2017/02/28/2017/java-performance/" rel="next" title="Java性能优化权威指南"><span>〈 </span>Java性能优化权威指南</a></div><div class="post-nav-item post-nav-prev"><a href="/2017/03/27/2017/mongoose-aggregate-by-date/" rel="prev" title="mongoose使用aggregate实现按照日期分组统计">mongoose使用aggregate实现按照日期分组统计 <span>〉</span></a></div></div><div id="toc" class="toc-article"><strong class="toc-title">目录</strong><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#序"><span class="toc-text">序</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#正文"><span class="toc-text">正文</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-创建配置文件app-json"><span class="toc-text">1. 创建配置文件app.json</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-在package-json中创建scripts-item"><span class="toc-text">2. 在package.json中创建scripts item</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-运行"><span class="toc-text">3. 运行</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考"><span class="toc-text">参考</span></a></li></ol></div></div></div><footer class="footer text-center"><div id="bottom-inner"><a href="" target="_blank" class="footer-link">Hexo</a> <a href="" target="_blank" class="footer-link">Theme microb</a></div></footer><script>var titleTime,originTitle=document.title;document.addEventListener("visibilitychange",function(){document.hidden?(document.title="[闷声发大财中...] "+originTitle,clearTimeout(titleTime)):(document.title="[+1s] "+originTitle,titleTime=setTimeout(function(){document.title=originTitle},2e3))})</script><script>!function(n,e){!function(){var n=e.getElementById("menu-main-post");if(n){var t=e.getElementById("toc");t?n.onclick=function(){t&&("block"==t.style.display?t.style.display="none":t.style.display="block")}:n.style.display="none"}}()}(window,document)</script><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?b6d76ecb62c0651d8e5b7f7085f443f1";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script>!function(e,a,t,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=a.createElement(t),s=a.getElementsByTagName(t)[0],o.async=1,o.src="//www.google-analytics.com/analytics.js",s.parentNode.insertBefore(o,s)}(window,document,"script",0,"ga"),ga("create","UA-78267963-1","auto"),ga("send","pageview")</script></body></html>