<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="theme-color" content="#202020"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="keywords" content="坑,MongoDB,mongoose,"><meta name="description" content="MongoDB从3.2升级到3.6的二三事"><link rel="icon" type="image/x-icon" href="/logo.png"><title>MongoDB从3.2升级到3.6的二三事 [ 大新闻 ]</title><link rel="stylesheet" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" href="/css/microb.css"></head><body><nav class="home-menu pure-menu pure-menu-horizontal pure-menu-fixed"><ul class="pure-menu-list float-r clearfix"><li class="pure-menu-item toc-menu"><a id="menu-main-post" class="pure-menu-link" href="javascript:;"><img class="menu-icon" src="/logo.png" alt="MENU"></a></li></ul><a class="pure-menu-heading" href="/"><h1 class="title">大新闻</h1></a></nav><div class="container" id="content-outer"><div class="inner" id="content-inner"><article class="post" id="post"><header class="post-header text-center"><h1 class="title">MongoDB从3.2升级到3.6的二三事</h1><time class="time" datetime="2017-12-15T05:18:17.000Z">2017-12-15</time><hr></header><div class="post-content"><blockquote><p>Node项目使用MongoDB，从3.2升级到3.6.0的几个坑。</p></blockquote><a id="more"></a><h2 id="0-项目背景"><a href="#0-项目背景" class="headerlink" title="0. 项目背景"></a>0. 项目背景</h2><ul><li>Node.js 8.x</li><li>mongoose 4.11.7 -&gt; 4.13.7</li><li>MongoDB 3.2.x -&gt; 3.6.0</li></ul><h2 id="1-数据库文件不兼容"><a href="#1-数据库文件不兼容" class="headerlink" title="1. 数据库文件不兼容"></a>1. 数据库文件不兼容</h2><p>使用相同的配置文件，MongoDB服务启动出错。配置文件如下：</p><figure class="highlight yaml"><table><tr><td class="code"><pre><div class="line"><span class="attr">systemLog:</span></div><div class="line"><span class="attr">  destination:</span> <span class="string">file</span></div><div class="line"><span class="attr">  path:</span> <span class="attr">d:\MongoDB\log\mongo.log</span></div><div class="line"><span class="attr">  logAppend:</span> <span class="literal">true</span></div><div class="line"><span class="attr">storage:</span></div><div class="line"><span class="attr">  dbPath:</span> <span class="attr">d:\MongoDB\data</span></div></pre></td></tr></table></figure><h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><p>具体原因未知，只好做数据迁移。</p><h2 id="2-aggregate未指定cursor选项导致报错"><a href="#2-aggregate未指定cursor选项导致报错" class="headerlink" title="2. aggregate未指定cursor选项导致报错"></a>2. aggregate未指定cursor选项导致报错</h2><p>报错堆栈：</p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">error:  MongoError: The &apos;cursor&apos; option is required, except for aggregate with the explain argument</div><div class="line">    at Function.MongoError.create (/opt/live/source/live-server/node_modules/mongodb-core/lib/error.js:31:11)</div><div class="line">    at /opt/live/source/live-server/node_modules/mongodb-core/lib/connection/pool.js:497:72</div><div class="line">    at authenticateStragglers (/opt/live/source/live-server/node_modules/mongodb-core/lib/connection/pool.js:443:16)</div><div class="line">    at Connection.messageHandler (/opt/live/source/live-server/node_modules/mongodb-core/lib/connection/pool.js:477:5)</div><div class="line">    at Socket.&lt;anonymous&gt; (/opt/live/source/live-server/node_modules/mongodb-core/lib/connection/connection.js:331:22)</div><div class="line">    at emitOne (events.js:116:13)</div><div class="line">    at Socket.emit (events.js:211:7)</div><div class="line">    at addChunk (_stream_readable.js:263:12)</div><div class="line">    at readableAddChunk (_stream_readable.js:250:11)</div><div class="line">    at Socket.Readable.push (_stream_readable.js:208:10)</div><div class="line">    at TCP.onread (net.js:594:20)</div></pre></td></tr></table></figure><h3 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h3><p>从MongoDB 3.5.x开始必须在使用aggregate时必须指定cursor选项。</p><p>参考：</p><ul><li><a href="https://stackoverflow.com/questions/43442588/mongoose-aggregation-query-fails-in-jest-mockgoose-test-works-elsewhere" target="_blank" rel="external">Mongoose aggregation query fails in Jest/Mockgoose test, works elsewhere</a></li></ul><h3 id="解决方案-1"><a href="#解决方案-1" class="headerlink" title="解决方案"></a>解决方案</h3><p>如果是mongoose项目升级到4.13.7。</p><h2 id="3-Unknown-modifier-pushAll"><a href="#3-Unknown-modifier-pushAll" class="headerlink" title="3. Unknown modifier $pushAll"></a>3. Unknown modifier $pushAll</h2><p>报错堆栈</p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">MongoError: Unknown modifier: $pushAll</div><div class="line">    at Function.MongoError.create (/opt/live/source/live-server/node_modules/mongodb-core/lib/error.js:31:11)</div><div class="line">    at toError (/opt/live/source/live-server/node_modules/mongodb/lib/utils.js:139:22)</div><div class="line">    at /opt/live/source/live-server/node_modules/mongodb/lib/collection.js:1060:67</div><div class="line">    at /opt/live/source/live-server/node_modules/mongodb-core/lib/connection/pool.js:469:18</div><div class="line">    at _combinedTickCallback (internal/process/next_tick.js:131:7)</div><div class="line">    at process._tickDomainCallback (internal/process/next_tick.js:218:9)</div><div class="line">You have triggered an unhandledRejection, you may have forgotten to catch a Promise rejection:</div></pre></td></tr></table></figure><h3 id="原因-1"><a href="#原因-1" class="headerlink" title="原因"></a>原因</h3><p>从 MongoDB 3.6开始，此方法被移除了。It is trying to use <code>$pushAll</code>, which is deprecated since 2.4 and it is not in MongoDB 3.6.</p><h3 id="解决方案-2"><a href="#解决方案-2" class="headerlink" title="解决方案"></a>解决方案</h3><p>如果使用Mongoose 4.x，创建Scheme时，指定<code>usePushEach</code>选项。或者升级到Mongoose 5.x(此时还未发布)。</p><figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line"><span class="keyword">new</span> Schema(obj, &#123; <span class="attr">usePushEach</span>: <span class="literal">true</span> &#125;);</div></pre></td></tr></table></figure><ul><li><a href="https://github.com/Automattic/mongoose/issues/5870" target="_blank" rel="external">https://github.com/Automattic/mongoose/issues/5870</a></li></ul></div><div class="post-tags"><ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MongoDB/">MongoDB</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mongoose/">mongoose</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/坑/">坑</a></li></ul></div></article><div class="post-nav"><div class="post-nav-item post-nav-next"><a href="/2017/11/23/2017/learn-spring-cloud-01/" rel="next" title="学习Spring Cloud：Discovery"><span>〈 </span>学习Spring Cloud：Discovery</a></div><div class="post-nav-item post-nav-prev"><a href="/2017/12/18/2017/consistent-hashing/" rel="prev" title="一致性Hash算法（Consistent Hashing）">一致性Hash算法（Consistent Hashing） <span>〉</span></a></div></div><div id="toc" class="toc-article"><strong class="toc-title">目录</strong><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0-项目背景"><span class="toc-text">0. 项目背景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-数据库文件不兼容"><span class="toc-text">1. 数据库文件不兼容</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#解决方案"><span class="toc-text">解决方案</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-aggregate未指定cursor选项导致报错"><span class="toc-text">2. aggregate未指定cursor选项导致报错</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#原因"><span class="toc-text">原因</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#解决方案-1"><span class="toc-text">解决方案</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-Unknown-modifier-pushAll"><span class="toc-text">3. Unknown modifier $pushAll</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#原因-1"><span class="toc-text">原因</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#解决方案-2"><span class="toc-text">解决方案</span></a></li></ol></li></ol></div></div></div><footer class="footer text-center"><div id="bottom-inner"><a href="http://hexo.io" target="_blank" class="footer-link">Hexo</a> <a href="https://github.com/microacup/hexo-theme-micorb" target="_blank" class="footer-link">Theme microb</a></div></footer><script>var titleTime,originTitle=document.title;document.addEventListener("visibilitychange",function(){document.hidden?(document.title="[闷声发大财中...] "+originTitle,clearTimeout(titleTime)):(document.title="[+1s] "+originTitle,titleTime=setTimeout(function(){document.title=originTitle},2e3))})</script><script>!function(e,n){function t(){cancelAnimationFrame(o),o=requestAnimationFrame(function e(){var t=n.body.scrollTop||n.documentElement.scrollTop;t>0?(n.body.scrollTop=n.documentElement.scrollTop=t-50,o=requestAnimationFrame(e)):cancelAnimationFrame(o)})}e.requestAnimationFrame=e.requestAnimationFrame||e.webkitRequestAnimationFrame||e.mozRequestAnimationFrame||e.oRequestAnimationFrame||e.msRequestAnimationFrame||function(e){setTimeout(e,1e3/60)},function(){var e=n.getElementById("menu-main-post");if(e){var o=n.getElementById("toc");e.title=o?"目录":"回到顶部",e.onclick=function(){o?"block"==o.style.display?o.style.display="none":o.style.display="block":t()}}}();var o=null}(window,document)</script><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?b6d76ecb62c0651d8e5b7f7085f443f1";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script>!function(e,a,t,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=a.createElement(t),s=a.getElementsByTagName(t)[0],o.async=1,o.src="//www.google-analytics.com/analytics.js",s.parentNode.insertBefore(o,s)}(window,document,"script",0,"ga"),ga("create","UA-78267963-1","auto"),ga("send","pageview")</script></body></html>